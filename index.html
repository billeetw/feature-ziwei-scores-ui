<!DOCTYPE html>
 <!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç´«å¾®è–äºº0.1ï½œä¸€èµ·å‡ºä¾†ç©</title>
  <title>ç´«å¾®è–äºº0.2ï½œä¸€èµ·å‡ºä¾†ç©</title>

  <!-- Tailwind CDNï¼ˆé–‹ç™¼ç”¨ï¼‰ -->
  <script src="https://cdn.tailwindcss.com"></script>
@@ -64,19 +64,6 @@
    .wuxing-é‡‘{background:#e5e7eb}
    .wuxing-æ°´{background:#3b82f6}

    /* äº”è¡Œ bar å‹•ç•« */
    .wx-row{
      opacity: 0;
      animation: fadeInUp 0.35s ease-out forwards;
    }
    .wx-bar-inner{
      transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes fadeInUp{
      from{ opacity:0; transform: translateY(4px); }
      to{ opacity:1; transform: translateY(0); }
    }
    /* æ˜Ÿæ›œäº”è¡Œé¡è‰² */
    .star-wx-æœ¨ { color: #86efac; text-shadow: 0 0 5px rgba(34,197,94,0.5); }
    .star-wx-ç« { color: #fca5a5; text-shadow: 0 0 5px rgba(239,68,68,0.5); }
@@ -236,7 +223,7 @@
  <div class="nav-bar flex items-center justify-between gap-3">
    <div class="flex items-center gap-2">
      <div class="font-black tracking-[0.22em] text-[10px] uppercase">ä¸€èµ·å‡ºä¾†ç©</div>
      <div class="text-[10px] opacity-85">ç´«å¾®è–äºº0.1</div>
      <div class="text-[10px] opacity-85">ç´«å¾®è–äºº0.2</div>
    </div>

    <!-- workspace nav (only after system entered) -->
@@ -260,7 +247,7 @@
    <header id="landing" class="text-center space-y-3">
      <p class="section-subtitle">2026 Strategic Command Hub</p>
      <h1 class="text-3xl md:text-5xl font-black tracking-tight">
        ç´«å¾®è–äºº0.1
        ç´«å¾®è–äºº0.2
      </h1>
      <p class="text-sm text-slate-400 max-w-3xl mx-auto">
        å¾Œç«¯åŒæ­¥è¨ˆç®—ï¼šå…«å­—äº”è¡Œï¼ˆå«è—å¹²åŠ æ¬Šï¼‰ï¼‹åç¥ä¸»è»¸ï¼‹2026 æµæœˆç´…ç¶ ç‡ˆï¼‹ç´«å¾® 12 å®®ä¸»/å‰¯æ˜Ÿã€‚<br/>
@@ -330,40 +317,32 @@ <h2 class="text-lg font-black">è¼¸å…¥å‡ºç”Ÿè³‡æ–™</h2>
        <div class="space-y-8">

          <!-- ç´«å¾® -->
          <section id="ws-ziwei" class="glass p-6 md:p-7 space-y-4">
            <div class="flex items-start justify-between gap-3">
              <!-- é€™è£¡çœç•¥åŸæœ¬å…§æ–‡ï¼Œèˆ‡ä½ ä¸Šä¸€ç‰ˆç›¸åŒ -->
              <div>
                <div class="section-subtitle mb-1">ZiWei DouShu</div>
                <h2 class="text-xl font-black tracking-tight">ç´«å¾® 12 å®® Â· ä½œæˆ°ç‰ˆæ–¹ç›¤</h2>
                <p class="text-xs text-slate-400 mt-1" id="ziweiMeta">
                  å‘½å®®èˆ‡èº«ä¸»æœƒé¡¯ç¤ºåœ¨ä¸­å¤®ï¼›å¤–åœˆ 12 å®®å›ºå®šä½ˆå±€ï¼Œèˆ‡ä¸»æµæ’ç›¤æ–¹å‘ä¸€è‡´ã€‚
                </p>
              </div>
            </div>
       <section id="ws-ziwei" class="glass p-6 md:p-7 space-y-4">
  <div class="flex items-start justify-between gap-3">
    ...
  </div>

            <div id="ziweiGrid" class="zw-grid-container"></div>
  <div id="ziweiGrid" class="zw-grid-container"></div>

            <div class="text-xs text-slate-400" id="ziweiHint"></div>
  <div class="text-xs text-slate-400" id="ziweiHint"></div>

            <!-- ç´«å¾®åˆ†æ•¸ -->
            <section id="ws-ziwei-scores" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="rounded-xl border border-white/10 p-4">
                <div class="text-xs font-semibold text-slate-200 mb-2">å®®ä½å¼·åº¦</div>
                <div id="ziweiPalaceScores"></div>
              </div>
              <div class="rounded-xl border border-white/10 p-4">
                <div class="text-xs font-semibold text-slate-200 mb-2">ç´«å¾®äº”è¡Œæ¯”ä¾‹</div>
                <div id="ziweiWuxingScores">
                  <div id="ziweiWx"></div>
                </div>
              </div>
            </section>
          </section>
  <!-- âœ… æ–°å¢ï¼šç´«å¾®åˆ†æ•¸å€å¡Šï¼ˆæ³¨æ„ï¼šé€™è£¡åœ¨ HTML è£¡ï¼Œä¸åœ¨ <script> è£¡ï¼‰ -->
  <section id="ws-ziwei-scores" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
    <div class="rounded-xl border border-white/10 p-4">
      <div class="text-xs font-semibold text-slate-200 mb-2">å®®ä½å¼·åº¦</div>
      <div id="ziweiPalaceScores"></div>
    </div>
    <div class="rounded-xl border border-white/10 p-4">
      <div class="text-xs font-semibold text-slate-200 mb-2">ç´«å¾®äº”è¡Œæ¯”ä¾‹</div>
      <div id="ziweiWuxingScores">
        <div id="ziweiWx"></div>
      </div>
    </div>
  </section>
</section>

          <!-- å…«å­—äº”è¡Œ -->
          <!-- ï¼ˆä»¥ä¸‹å’Œä½ åŸæœ¬ä¸€æ¨£ï¼Œåªåœ¨ renderBar æœ‰æ”¹ï¼‰ -->

          <!-- å…«å­—äº”è¡Œ -->
          <section id="ws-bazi" class="glass p-6 md:p-7 space-y-6">
            <div>
              <div class="section-subtitle mb-1">BaZi + Elements</div>
@@ -407,21 +386,17 @@ <h2 class="text-xl font-black tracking-tight">å…«å­— Â· å››æŸ±ï¼‹äº”è¡Œæˆ°åŠ›</h
          </section>

          <!-- æµæœˆ -->
          <!-- ...ï¼ˆä¸­ç•¥ï¼Œèˆ‡ä½ åŸæœ¬ç›¸åŒï¼‰... -->
          <section id="ws-liuyue" class="glass p-6 md:p-7 space-y-4">
            <div>
              <div class="section-subtitle mb-1">2026 Monthly Flow</div>
              <h2 class="text-xl font-black tracking-tight">2026 æµæœˆç´…ç¶ ç‡ˆï¼ˆ12ï¼‰</h2>
              <p class="text-xs text-slate-400 mt-1">ğŸ”´ å£“åŠ›æœˆï¼šå…ˆå®ˆè¦å‰‡ï¼ğŸŸ¢ ç©©é€²æœˆï¼šé©åˆæ¨é€²å°ˆæ¡ˆ</p>
            </div>
            <div id="monthGrid" class="space-y-2"></div>
            <div id="monthDetailBox" class="mt-4 space-y-2 text-xs"></div>
             <div id="monthGrid" class="space-y-2"></div>
             <div id="monthDetailBox" class="mt-4 space-y-2 text-xs"></div>
          </section>

          <!-- æˆ°ç•¥é¢æ¿ã€è«®è©¢ CTA -->
          <!-- ... ä¿æŒä¸è®Š ... -->
          <!-- æˆ°ç•¥é¢æ¿ -->
          <section id="ws-strategy" class="glass p-6 md:p-7 space-y-4">
            <div>
              <div class="section-subtitle mb-1">Strategic Panel</div>
@@ -438,6 +413,7 @@ <h2 class="text-xl font-black tracking-tight">2026 æˆ°è¡“å»ºè­°ï¼ˆå‹•æ…‹æ±ºç­–
            </div>
          </section>

          <!-- è«®è©¢ CTA -->
          <section id="ws-consult" class="glass p-7 md:p-9 space-y-5 text-center border border-amber-400/40">
            <div>
              <div class="section-subtitle mb-1">1:1 Consulting</div>
@@ -456,7 +432,6 @@ <h2 class="text-2xl md:text-4xl font-black text-amber-300 tracking-tight">æƒ³æŠŠ
        </div>

        <!-- RIGHT DETAIL PANELï¼ˆæ¡Œæ©Ÿç”¨ï¼‰ -->
        <!-- ... ä¿æŒåŸæ¨£ ... -->
        <aside class="space-y-6" id="detailPanel">
          <div class="glass p-6 md:p-7 sticky top-24 border border-amber-500/30 overflow-y-auto max-h-[85vh]">
            <div class="section-subtitle mb-2">Palace Detail</div>
@@ -484,467 +459,1017 @@ <h2 class="text-2xl md:text-4xl font-black text-amber-300 tracking-tight">æƒ³æŠŠ
      </div>
    </section>
  </main>
<script>
  // ====== CONFIG ======
  const API_BASE = "https://17gonplay-api.billeetw.workers.dev";
  // ====== CONSTANTS ======
  // é è¨­ã€Œå®®ä½é †åºã€ï¼ˆå¾å‘½å®®é–‹å§‹é€†è¡Œï¼‰ï¼šåªç”¨ä¾†åšä¸‰æ–¹å››æ­£ç­‰ã€Œå®®ä½é‚è¼¯ã€ï¼Œè·Ÿç•«æ ¼å­çš„ä½ç½®åˆ†é–‹
  const PALACE_DEFAULT = [
    "å‘½å®®","å…„å¼Ÿ","å¤«å¦»","å­å¥³","è²¡å¸›","ç–¾å„",
    "é·ç§»","åƒ•å½¹","å®˜ç¥¿","ç”°å®…","ç¦å¾·","çˆ¶æ¯"
  ];
  // å¯¦éš›é‹è¡Œæ™‚ç”¨çš„ã€Œå®®ä½ç’°ã€ï¼ˆä»¥å‘½å®®ç‚ºèµ·é»çš„ 12 å®®é †åºï¼‰
  let PALACE_RING = PALACE_DEFAULT.slice();
  // å®®ä½ç°¡ç¹å°ç…§ï¼ˆæ‰¾æ˜Ÿæ›œã€æ‰¾è³‡æ–™åº«ç”¨ï¼‰
  const PALACE_KEY_MAP = {
    "å…„å¼Ÿ": ["å…„å¼Ÿ","å…„å¼Ÿå®®"],
    "å‘½å®®": ["å‘½å®®","å‘½å®«"],
    "å¤«å¦»": ["å¤«å¦»","å¤«å¦»å®®"],
    "å­å¥³": ["å­å¥³","å­å¥³å®®"],
    "è²¡å¸›": ["è²¡å¸›","è´¢å¸›","è²¡å¸›å®®","è´¢å¸›å®«"],
    "ç–¾å„": ["ç–¾å„","ç–¾å„å®®"],
    "é·ç§»": ["é·ç§»","è¿ç§»","é·ç§»å®®","è¿ç§»å®«"],
    "åƒ•å½¹": ["åƒ•å½¹","ä»†å½¹","åƒ•å½¹å®®","ä»†å½¹å®«"],
    "å®˜ç¥¿": ["å®˜ç¥¿","å®˜ç¦„","å®˜ç¥¿å®®","å®˜ç¦„å®«"],
    "ç”°å®…": ["ç”°å®…","ç”°å®…å®®"],
    "ç¦å¾·": ["ç¦å¾·","ç¦å¾·å®®"],
    "çˆ¶æ¯": ["çˆ¶æ¯","çˆ¶æ¯å®®"],
  };
  // 12 å®®ç›¤é¢ä½ç½®ï¼ˆ4x4 å¤–åœˆï¼‰â€” é€™æ˜¯ã€Œåœ°æ”¯åº§æ¨™ã€
  // ç´¢å¼•ï¼š0:å¯…(å·¦ä¸‹), 1:å¯, 2:è¾°, 3:å·³(å·¦ä¸Š), 4:åˆ, 5:æœª,
  //      6:ç”³(å³ä¸Š), 7:é…‰, 8:æˆŒ, 9:äº¥(å³ä¸‹),10:å­, 11:ä¸‘
  const gridAreas = [
    "4/1/5/2", // 0: å¯… (å·¦ä¸‹)
    "3/1/4/2", // 1: å¯
    "2/1/3/2", // 2: è¾°
    "1/1/2/2", // 3: å·³ (å·¦ä¸Š)
    "1/2/2/3", // 4: åˆ
    "1/3/2/4", // 5: æœª
    "1/4/2/5", // 6: ç”³ (å³ä¸Š)
    "2/4/3/5", // 7: é…‰
    "3/4/4/5", // 8: æˆŒ
    "4/4/5/5", // 9: äº¥ (å³ä¸‹)
    "4/3/5/4", // 10: å­
    "4/2/5/3"  // 11: ä¸‘
  ];
  // â­ æ–°å¢ï¼šå›ºå®šçš„ã€Œåœ°æ”¯ç’°ã€ï¼Œå°æ‡‰ä¸Šé¢ gridAreas çš„é †åº
  const BRANCH_RING = [
    "å¯…","å¯","è¾°","å·³","åˆ","æœª",
    "ç”³","é…‰","æˆŒ","äº¥","å­","ä¸‘"
  ];
  const STAR_NAME_TRAD_MAP = {
    // 14 ä¸»æ˜Ÿ
    "ç´«å¾®": "ç´«å¾®", "ç´«è–‡": "ç´«å¾®",
    "å¤©æœº": "å¤©æ©Ÿ", "å¤©æ©Ÿ": "å¤©æ©Ÿ",
    "å¤ªé˜³": "å¤ªé™½", "å¤ªé™½": "å¤ªé™½",
    "å¤ªé˜´": "å¤ªé™°", "å¤ªé™°": "å¤ªé™°",
    "æ­¦æ›²": "æ­¦æ›²",
    "å¤©åŒ": "å¤©åŒ",
    "å»‰è´": "å»‰è²", "å»‰è²": "å»‰è²",
    "å¤©åºœ": "å¤©åºœ",
    "è´ªç‹¼": "è²ªç‹¼", "è²ªç‹¼": "è²ªç‹¼",
    "å·¨é—¨": "å·¨é–€", "å·¨é–€": "å·¨é–€",
    "å¤©ç›¸": "å¤©ç›¸",
    "å¤©æ¢": "å¤©æ¢",
    "ä¸ƒæ€": "ä¸ƒæ®º", "ä¸ƒæ®º": "ä¸ƒæ®º",
    "ç ´å†›": "ç ´è»", "ç ´è»": "ç ´è»",
    // å…­å‰æ˜Ÿ
    "å·¦è¾…": "å·¦è¼”", "å·¦è¼”": "å·¦è¼”",
    "å³å¼¼": "å³å¼¼",
    "æ–‡æ˜Œ": "æ–‡æ˜Œ",
    "æ–‡æ›²": "æ–‡æ›²",
    "å¤©é­": "å¤©é­",
    "å¤©é’º": "å¤©é‰", "å¤©é‰": "å¤©é‰",
    // å…­ç…æ˜Ÿ
    "æ“ç¾Š": "æ“ç¾Š",
    "é™€ç½—": "é™€ç¾…", "é™€ç¾…": "é™€ç¾…",
    "ç«æ˜Ÿ": "ç«æ˜Ÿ",
    "é“ƒæ˜Ÿ": "éˆ´æ˜Ÿ", "éˆ´æ˜Ÿ": "éˆ´æ˜Ÿ",
    "åœ°åŠ«": "åœ°åŠ«",
    "åœ°ç©º": "åœ°ç©º",
    // é‡è¦è¼”æ˜Ÿ
    "ç¦„å­˜": "ç¥¿å­˜", "ç¥¿å­˜": "ç¥¿å­˜",
    "å¤©é©¬": "å¤©é¦¬", "å¤©é¦¬": "å¤©é¦¬",
    "å¤©ä¼¤": "å¤©å‚·", "å¤©å‚·": "å¤©å‚·",
    "å¤©ä½¿": "å¤©ä½¿",
    "å¤©æ‰": "å¤©æ‰",
    "å¤©å¯¿": "å¤©å£½", "å¤©å£½": "å¤©å£½",
    "å¤©å®˜": "å¤©å®˜",
    "å¤©ç¦": "å¤©ç¦",
    "å¤©å·«": "å¤©å·«",
    "å¤©å–œ": "å¤©å–œ",
    "å¤©å§š": "å¤©å§š",
    "ç´…é¸": "ç´…é¸", "çº¢é¸¾": "ç´…é¸",
    "å¤©åˆ‘": "å¤©åˆ‘",
    "è§£ç¥": "è§£ç¥",
    // --- è£œè¶³é›œæ›œèˆ‡ç¥ç… ---
    "å¤©å¨": "å¤©å»š", "å¤©å»š": "å¤©å»š",
    "æˆªè·¯": "æˆªè·¯",
    "å­¤è¾°": "å­¤è¾°",
    "å¯¡å®¿": "å¯¡å®¿",
    "ç©ºäº¡": "ç©ºäº¡",
    "ç ´ç¢": "ç ´ç¢",
    "å¤©è´µ": "å¤©è²´", "å¤©è²´": "å¤©è²´",
    "åç›–": "è¯è“‹", "è¯è“‹": "è¯è“‹",
    "å¤©å“­": "å¤©å“­",
    "å¤©è™š": "å¤©è™›", "å¤©è™›": "å¤©è™›",
    "å¤©å¾·": "å¤©å¾·",
    "æœˆå¾·": "æœˆå¾·",
    "æ—¬ç©º": "æ—¬ç©º",
    "å°è¾…": "å°è¼”", "å°è¼”": "å°è¼”",
    "å°è¯°": "å°èª¥", "å°èª¥": "å°èª¥",
    "é¾™æ± ": "é¾æ± ", "é¾æ± ": "é¾æ± ",
    "å‡¤é˜": "é³³é–£", "é³³é–£": "é³³é–£",
    "å¹´è§£": "å¹´è§£",
    "å’¸æ± ": "å’¸æ± ",
    "ä¸‰å°": "ä¸‰å°",
    "å…«åº§": "å…«åº§",
    "æ©å…‰": "æ©å…‰",
    "èœšå»‰": "èœšå»‰",
    "é˜´ç…": "é™°ç…", "é™°ç…": "é™°ç…",
    "å¤©æœˆ": "å¤©æœˆ",
    // åšå£«åäºŒç¥
    "åšå£«": "åšå£«",
    "åŠ›å£«": "åŠ›å£«",
    "é’é¾": "é’é¾", "é’é¾™": "é’é¾",
    "å°è€—": "å°è€—",
    "å°‡è»": "å°‡è»", "å°†å†›": "å°‡è»",
    "å¥æ›¸": "å¥æ›¸", "å¥ä¹¦": "å¥æ›¸",
    "å–œç¥": "å–œç¥",
    "ç—…ç¬¦": "ç—…ç¬¦",
    "å¤§è€—": "å¤§è€—",
    "ä¼å…µ": "ä¼å…µ",
    "å®˜åºœ": "å®˜åºœ",
    // é¡åˆ¥å‹æ˜Ÿæ›œ
    "ç”²ç´šä¸»æ˜Ÿ": "ç”²ç´šä¸»æ˜Ÿ",
    "å…­å‰æ˜Ÿ": "å…­å‰æ˜Ÿ",
    "å…­ç…æ˜Ÿ": "å…­ç…æ˜Ÿ",
    "å—æ–—ã€åŒ—æ–—æ˜Ÿ": "å—æ–—ã€åŒ—æ–—æ˜Ÿ",
    "ä¸­å¤©æ˜Ÿ": "ä¸­å¤©æ˜Ÿ",
    "è¼”åŠ©æ˜Ÿ": "è¼”åŠ©æ˜Ÿ",
    "ç¥¿å­˜èˆ‡å¤©é¦¬": "ç¥¿å­˜èˆ‡å¤©é¦¬"
  };
  function toTraditionalStarName(name){
    return STAR_NAME_TRAD_MAP[name] || name;
  }
  // äº”è¡Œ map ç”¨ã€Œç¹é«”æ˜Ÿåã€
  const STAR_WUXING_MAP = {
    "ç´«å¾®":"åœŸ","å¤©æ©Ÿ":"æœ¨","å¤ªé™½":"ç«","æ­¦æ›²":"é‡‘","å¤©åŒ":"æ°´",
    "å»‰è²":"ç«","å¤©åºœ":"åœŸ","å¤ªé™°":"æ°´","è²ªç‹¼":"æœ¨","å·¨é–€":"æ°´",
    "å¤©ç›¸":"æ°´","å¤©æ¢":"åœŸ","ä¸ƒæ®º":"é‡‘","ç ´è»":"æ°´",
  };
  // åœ°æ”¯è—å¹²ï¼ˆå‰ç«¯é¡¯ç¤ºç”¨ï¼‰
  const CANGGAN_DATA = {
    "å­": { "ç™¸": 1.0 },
    "ä¸‘": { "å·±": 0.6, "ç™¸": 0.3, "è¾›": 0.1 },
    "å¯…": { "ç”²": 0.6, "ä¸™": 0.3, "æˆŠ": 0.1 },
    "å¯": { "ä¹™": 1.0 },
    "è¾°": { "æˆŠ": 0.6, "ä¹™": 0.3, "ç™¸": 0.1 },
    "å·³": { "ä¸™": 0.6, "åºš": 0.3, "æˆŠ": 0.1 },
    "åˆ": { "ä¸": 0.7, "å·±": 0.3 },
    "æœª": { "å·±": 0.6, "ä¸": 0.3, "ä¹™": 0.1 },
    "ç”³": { "åºš": 0.6, "å£¬": 0.3, "æˆŠ": 0.1 },
    "é…‰": { "è¾›": 1.0 },
    "æˆŒ": { "æˆŠ": 0.6, "è¾›": 0.3, "ä¸": 0.1 },
    "äº¥": { "å£¬": 0.7, "ç”²": 0.3 },
  };
  const DEFAULT_WUXING_MEANINGS = {
    "æœ¨": { headline: "æˆé•·èˆ‡è¦åŠƒ", content: "æœ¨ä»£è¡¨ç”Ÿé•·ã€å»¶å±•ã€è¦åŠƒã€å­¸ç¿’èˆ‡äººéš›é€£çµã€‚æœ¨æ—ºå¤šä¸»ä¸»å‹•ã€é¡˜æ„æ¨é€²ï¼›æœ¨å¼±å¸¸éœ€è£œç­–ç•¥èˆ‡é•·æœŸå¸ƒå±€ã€‚" },
    "ç«": { headline: "èƒ½è¦‹åº¦èˆ‡å‹•èƒ½", content: "ç«ä»£è¡¨è¡¨é”ã€æ›å…‰ã€ç†±æƒ…ã€æ¨å‹•èˆ‡æ±ºç­–é€Ÿåº¦ã€‚ç«æ—ºæ˜“è¡éé ­ã€æƒ…ç·’æ±ºç­–ï¼›ç«å¼±å‰‡è¡Œå‹•èˆ‡è‡ªä¿¡ä¸è¶³ã€‚" },
    "åœŸ": { headline: "æ‰¿æ¥èˆ‡ç³»çµ±", content: "åœŸä»£è¡¨ç©©å®šã€å®¹å™¨ã€æµç¨‹ã€è¦ç¯„èˆ‡æŒä¹…åŠ›ã€‚åœŸæ—ºæ˜“æ²‰é‡ä¿å®ˆï¼›åœŸå¼±å‰‡é›£è½åœ°ã€ç¼ºä¹æ‰¿è¼‰ã€‚" },
    "é‡‘": { headline: "çµæ§‹èˆ‡ç•Œç·š", content: "é‡‘ä»£è¡¨è¦å‰‡ã€åˆ‡å‰²ã€æ•ˆç‡ã€æ¨™æº–èˆ‡é¢¨éšªæ§åˆ¶ã€‚é‡‘æ—ºå®¹æ˜“è‹›åˆ»ã€å£“è¿«ï¼›é‡‘å¼±å‰‡ç•Œç·šé¬†æ•£ã€åŸ·è¡Œæ¨™æº–ä¸ç©©ã€‚" },
    "æ°´": { headline: "æµå‹•èˆ‡æ´å¯Ÿ", content: "æ°´ä»£è¡¨è³‡è¨Šã€è³‡æºæµå‹•ã€æ´å¯Ÿèˆ‡é©æ‡‰ã€‚æ°´æ—ºå¸¸å¤šæƒ³å¤šè®Šï¼›æ°´å¼±å‰‡è¦–é‡è®Šçª„ã€è³‡æºèª¿åº¦ä¸é †ã€‚" },
  };
  // ====== STATE ======
  let dbContent = { palaces:{}, stars:{}, tenGods:{}, wuxing:{} };
  let contract = null;
  let selectedPalace = "å‘½å®®";
  // ====== HELPERS ======
  function pad2(n){ return String(n).padStart(2,"0"); }
  function getStarsForPalace(ziwei, palaceName){
    if (!ziwei || !ziwei.mainStars) return [];
    const keys = PALACE_KEY_MAP[palaceName] || [palaceName];
    const all = [];
    keys.forEach(k=>{
      const list = ziwei.mainStars[k];
      if (Array.isArray(list)) list.forEach(s => all.push(s));
    });
    return all;
  }
// targetId: è¦å¡é€²å»çš„å®¹å™¨ id (e.g. "surfaceWx")
// data:    å½¢å¦‚ { æœ¨: 3.2, ç«: 1.0, åœŸ: 0, é‡‘: 4.5, æ°´: 2.1 }
// max:     æœ€å¤§å€¼ï¼Œç”¨ä¾†ç®—ç™¾åˆ†æ¯”ï¼Œå¦‚æœä½ å·²ç¶“å…ˆç®—å¥½ä¹Ÿå¯ä»¥ç›´æ¥å‚³
function renderBar(targetId, data, max) {
  const box = document.getElementById(targetId);
  if (!box) return;
  box.innerHTML = "";
  const order = ["æœ¨", "ç«", "åœŸ", "é‡‘", "æ°´"];
  // å¦‚æœæ²’å‚³ maxï¼Œå°±è‡ªå·±å¾ data è£¡æŠ“æœ€å¤§å€¼
  let autoMax = 0;
  if (!max) {
    order.forEach(k => {
      const v = Number(data?.[k] || 0);
      if (v > autoMax) autoMax = v;
    });
    max = autoMax || 1; // é¿å…é™¤ä»¥ 0
  }
  order.forEach((elementName, index) => {
    const v = Number(data?.[elementName] || 0);
    const w = max ? Math.max(3, (v / max) * 100) : 0; // è‡³å°‘ 3%
    // æ¯ä¸€åˆ—åŠ ä¸€å€‹æœ‰å‹•ç•«çš„å®¹å™¨ï¼Œdelay ä¾ index èª¿æ•´
    const rowId = `${targetId}-row-${elementName}`;
    const barId = `${targetId}-${elementName}`;
    const delay = index * 0.1; // 0, 0.1s, 0.2s...
    box.insertAdjacentHTML(
      "beforeend",
      `
      <div class="mb-1 wx-row-animated" id="${rowId}" style="animation-delay:${delay}s">
        <div class="flex justify-between text-xs text-slate-300 mb-0.5">
          <span class="font-bold">${elementName}</span>
          <span class="font-mono">${v.toFixed(1)}</span>
        </div>
        <div class="h-2 bg-white/10 rounded overflow-hidden">
          <div
            class="h-full wuxing-${elementName} wx-bar-inner"
            style="width:0%;"
            id="${barId}"
          ></div>
        </div>
      </div>
      `
    );
    // ç­‰ DOM æ’å…¥å¾Œï¼Œå†æŠŠå¯¬åº¦å¾ 0 æ¨åˆ°ç›®æ¨™ç™¾åˆ†æ¯”ï¼Œåƒ transition å‹•ç•«
    setTimeout(() => {
      const bar = document.getElementById(barId);
      if (bar) {
        bar.style.width = `${w}%`;
      }
    }, 50); // 50ms è®“ç€è¦½å™¨å…ˆ paint ä¸€æ¬¡
  });
}
  function pctFromWx(wx){
    const total = Object.values(wx||{}).reduce((s,v)=>s+(Number(v)||0),0) || 1;
    const pct = {};
    ["æœ¨","ç«","åœŸ","é‡‘","æ°´"].forEach(k => pct[k] = (Number(wx?.[k]||0)/total));
    return { total, pct };
  }
  function computeDynamicTactics(bazi){
    const out = [];
    const dominant = (bazi?.tenGod?.dominant || "").trim();
    const wx = bazi?.wuxing?.strategic || null;
    if (!wx) return out;
    const { pct } = pctFromWx(wx);
    if (pct["ç«"] >= 0.35) out.push({ tone:"red", text:"ğŸ”¥ ç«ä½”æ¯”åé«˜ï¼šä»Šå¹´åšé‡å¤§æ±ºç­–å»ºè­°ã€Œå†·å» 48 å°æ™‚ã€ï¼Œå…ˆå¯«ä¸‹é¢¨éšªæ¸…å–®å†æ‹æ¿ã€‚" });
    if (pct["æ°´"] <= 0.10) out.push({ tone:"blue", text:"ğŸ’§ æ°´ä½”æ¯”åä½ï¼šéœ€è¦åˆ»æ„è£œå……è³‡è¨Šèˆ‡è³‡æºæµå‹•ï¼ˆè·¨ç•Œäº¤æµã€å»ºç«‹è³‡æ–™åº«ã€åšç¾é‡‘æµç·©è¡ï¼‰ã€‚" });
    if (pct["é‡‘"] >= 0.35) out.push({ tone:"slate", text:"âš”ï¸ é‡‘ä½”æ¯”åé«˜ï¼šåŸ·è¡Œæ¨™æº–å¼·ï¼Œä½†æ˜“è®“åˆä½œå£“åŠ›ä¸Šå‡ã€‚å»ºè­°ç”¨æµç¨‹å–ä»£æƒ…ç·’ï¼Œå…ˆå°é½Šè¦æ ¼å†è¦æ±‚é€Ÿåº¦ã€‚" });
    if (pct["åœŸ"] >= 0.40) out.push({ tone:"amber", text:"â›°ï¸ åœŸä½”æ¯”åé«˜ï¼šæ‰¿è¼‰åŠ›å¼·ä½†ç¯€å¥æ˜“éˆã€‚å»ºè­°æŠŠå¤§ç›®æ¨™æ‹†æˆé€±ç¯€é»ï¼Œç”¨å„€è¡¨æ¿æ¨é€²è€Œä¸æ˜¯é æ„å¿—åŠ›ã€‚" });
    if (pct["æœ¨"] >= 0.35) out.push({ tone:"green", text:"ğŸŒ² æœ¨ä½”æ¯”åé«˜ï¼šæ“´å¼µèˆ‡è¦åŠƒå¾ˆå¼·ï¼Œä½†æ³¨æ„æˆ°ç·šéå¤šã€‚å»ºè­°åšã€å‰ªæã€ï¼šç æ‰ 20% ä¸å¿…è¦ä»»å‹™ï¼Œæˆæœæœƒæ›´å¤§ã€‚" });
    if (dominant && dbContent.tenGods?.[dominant]){
      out.push({ tone:"amber", text:`ğŸ§­ åç¥ä¸»è»¸ï¼ˆ${dominant}ï¼‰ï¼š${dbContent.tenGods[dominant]}` });
    } else if (dominant) {
      out.push({ tone:"amber", text:`ğŸ§­ åç¥ä¸»è»¸ï¼ˆ${dominant}ï¼‰ï¼šä»Šå¹´ç”¨ã€Œæµç¨‹åŒ–ã€è¦å‰‡åŒ–ã€æ–¹å¼æ¨é€²ï¼Œå£“åŠ›æœˆå…ˆå®ˆè¦å‰‡å†è«‡çªç ´ã€‚` });
    }

  <script>
    // ====== CONFIG ======
    const API_BASE = "https://17gonplay-api.billeetw.workers.dev";
    // ====== CONSTANTS ======
    // å›ºå®šç›¤é¢ï¼šindex å°æ‡‰ï¼š
    // 0:ç–¾å„, 1:è²¡å¸›, 2:å­å¥³, 3:å¤«å¦»,
    // 4:å…„å¼Ÿ, 5:å‘½å®®, 6:çˆ¶æ¯, 7:ç¦å¾·,
    // 8:ç”°å®…, 9:å®˜ç¥¿, 10:åƒ•å½¹(äº¤å‹), 11:é·ç§»
    const PALACE_DEFAULT = [
      "ç–¾å„","è²¡å¸›","å­å¥³","å¤«å¦»",
      "å…„å¼Ÿ","å‘½å®®","çˆ¶æ¯","ç¦å¾·",
      "ç”°å®…","å®˜ç¥¿","åƒ•å½¹","é·ç§»"
    return out;
  }
  function toneClass(tone){
    if (tone === "red") return "border-red-400/60 bg-red-500/10 text-red-100";
    if (tone === "blue") return "border-blue-400/60 bg-blue-500/10 text-blue-100";
    if (tone === "green") return "border-emerald-400/60 bg-emerald-500/10 text-emerald-100";
    if (tone === "slate") return "border-slate-400/40 bg-white/5 text-slate-100";
    return "border-amber-400/60 bg-amber-500/10 text-amber-100";
  }
  function renderWuxingMeaningBox(){
    const box = document.getElementById("wuxingMeaningBox");
    if (!box) return;
    box.innerHTML = "";
    const src = (dbContent.wuxing && Object.keys(dbContent.wuxing).length)
      ? dbContent.wuxing
      : DEFAULT_WUXING_MEANINGS;
    ["æœ¨","ç«","åœŸ","é‡‘","æ°´"].forEach(el=>{
      const item = src[el] || DEFAULT_WUXING_MEANINGS[el];
      box.innerHTML += `
        <div class="p-3 rounded-xl border border-white/10 bg-white/5">
          <div class="flex items-center justify-between">
            <div class="font-black text-slate-100">${el}</div>
            <div class="text-[10px] text-slate-400">${item?.headline || ""}</div>
          </div>
          <div class="text-xs text-slate-300 mt-2 leading-relaxed">${item?.content || ""}</div>
        </div>
      `;
    });
  }
  // ====== RENDER: BAZI ======
  function renderPillars(bazi){
    const grid = document.getElementById("pillarsGrid");
    if (!grid) return;
    grid.innerHTML = "";
    const disp = bazi?.display || {};
    const cols = [
      { label:"å¹´", g:disp.yG, z:disp.yZ, dim:false },
      { label:"æœˆ", g:disp.mG, z:disp.mZ, dim:false },
      { label:"æ—¥", g:disp.dG, z:disp.dZ, dim:true  },
      { label:"æ™‚", g:disp.hG, z:disp.hZ, dim:false },
    ];

    let PALACE_RING = PALACE_DEFAULT.slice();
    // å®®ä½ç°¡ç¹å°ç…§
    const PALACE_KEY_MAP = {
      "å…„å¼Ÿ": ["å…„å¼Ÿ"],
      "å‘½å®®": ["å‘½å®®","å‘½å®«"],
      "å¤«å¦»": ["å¤«å¦»"],
      "å­å¥³": ["å­å¥³"],
      "è²¡å¸›": ["è²¡å¸›","è´¢å¸›"],
      "ç–¾å„": ["ç–¾å„"],
      "é·ç§»": ["é·ç§»","è¿ç§»"],
      "åƒ•å½¹": ["åƒ•å½¹","ä»†å½¹","äº¤å‹"],
      "å®˜ç¥¿": ["å®˜ç¥¿","å®˜ç¦„","äº‹æ¥­","äº‹ä¸š"],
      "ç”°å®…": ["ç”°å®…"],
      "ç¦å¾·": ["ç¦å¾·"],
      "çˆ¶æ¯": ["çˆ¶æ¯"],
    };
    cols.forEach(c=>{
      grid.innerHTML += `
        <div class="p-3 rounded-xl border border-white/10 bg-white/5">
          <div class="text-[10px] text-slate-500 font-black tracking-widest">${c.label}</div>
          <div class="bazi-char ${c.dim ? "text-amber-400" : ""}">${c.g || "â€”"}</div>
          <div class="text-sm text-slate-300">${c.z || "â€”"}</div>
        </div>
      `;
    });

    // 12 å®®ç›¤é¢ä½ç½®ï¼ˆ4x4 å¤–åœˆï¼‰
    // ç´¢å¼•ï¼š0:å¯…(å·¦ä¸‹), 1:å¯, 2:è¾°, 3:å·³(å·¦ä¸Š), 4:åˆ, 5:æœª, 6:ç”³(å³ä¸Š), 7:é…‰, 8:æˆŒ, 9:äº¥(å³ä¸‹), 10:å­, 11:ä¸‘
    const gridAreas = [
      "4/1/5/2", // 0: å¯… (å·¦ä¸‹)
      "3/1/4/2", // 1: å¯
      "2/1/3/2", // 2: è¾°
      "1/1/2/2", // 3: å·³ (å·¦ä¸Š)
      "1/2/2/3", // 4: åˆ
      "1/3/2/4", // 5: æœª
      "1/4/2/5", // 6: ç”³ (å³ä¸Š)
      "2/4/3/5", // 7: é…‰
      "3/4/4/5", // 8: æˆŒ
      "4/4/5/5", // 9: äº¥ (å³ä¸‹)
      "4/3/5/4", // 10: å­
      "4/2/5/3"  // 11: ä¸‘
    const cgBox = document.getElementById("cangganGrid");
    if (!cgBox) return;
    cgBox.innerHTML = "";
    const branches = [
      { label:"å¹´æ”¯", z:disp.yZ },
      { label:"æœˆæ”¯", z:disp.mZ },
      { label:"æ—¥æ”¯", z:disp.dZ },
      { label:"æ™‚æ”¯", z:disp.hZ },
    ];

    const STAR_NAME_TRAD_MAP = {
      // 14 ä¸»æ˜Ÿ + å…¶ä»–ï¼ˆä¿æŒä½ åŸæœ¬å…§å®¹ï¼‰
      "ç´«å¾®": "ç´«å¾®", "ç´«è–‡": "ç´«å¾®",
      "å¤©æœº": "å¤©æ©Ÿ", "å¤©æ©Ÿ": "å¤©æ©Ÿ",
      "å¤ªé˜³": "å¤ªé™½", "å¤ªé™½": "å¤ªé™½",
      "å¤ªé˜´": "å¤ªé™°", "å¤ªé™°": "å¤ªé™°",
      "æ­¦æ›²": "æ­¦æ›²",
      "å¤©åŒ": "å¤©åŒ",
      "å»‰è´": "å»‰è²", "å»‰è²": "å»‰è²",
      "å¤©åºœ": "å¤©åºœ",
      "è´ªç‹¼": "è²ªç‹¼", "è²ªç‹¼": "è²ªç‹¼",
      "å·¨é—¨": "å·¨é–€", "å·¨é–€": "å·¨é–€",
      "å¤©ç›¸": "å¤©ç›¸",
      "å¤©æ¢": "å¤©æ¢",
      "ä¸ƒæ€": "ä¸ƒæ®º", "ä¸ƒæ®º": "ä¸ƒæ®º",
      "ç ´å†›": "ç ´è»", "ç ´è»": "ç ´è»",
      "å·¦è¾…": "å·¦è¼”", "å·¦è¼”": "å·¦è¼”",
      "å³å¼¼": "å³å¼¼",
      "æ–‡æ˜Œ": "æ–‡æ˜Œ",
      "æ–‡æ›²": "æ–‡æ›²",
      "å¤©é­": "å¤©é­",
      "å¤©é’º": "å¤©é‰", "å¤©é‰": "å¤©é‰",
      "æ“ç¾Š": "æ“ç¾Š",
      "é™€ç½—": "é™€ç¾…", "é™€ç¾…": "é™€ç¾…",
      "ç«æ˜Ÿ": "ç«æ˜Ÿ",
      "é“ƒæ˜Ÿ": "éˆ´æ˜Ÿ", "éˆ´æ˜Ÿ": "éˆ´æ˜Ÿ",
      "åœ°åŠ«": "åœ°åŠ«",
      "åœ°ç©º": "åœ°ç©º",
      "ç¦„å­˜": "ç¥¿å­˜", "ç¥¿å­˜": "ç¥¿å­˜",
      "å¤©é©¬": "å¤©é¦¬", "å¤©é¦¬": "å¤©é¦¬",
      "å¤©ä¼¤": "å¤©å‚·", "å¤©å‚·": "å¤©å‚·",
      "å¤©ä½¿": "å¤©ä½¿",
      "å¤©æ‰": "å¤©æ‰",
      "å¤©å¯¿": "å¤©å£½", "å¤©å£½": "å¤©å£½",
      "å¤©å®˜": "å¤©å®˜",
      "å¤©ç¦": "å¤©ç¦",
      "å¤©å·«": "å¤©å·«",
      "å¤©å–œ": "å¤©å–œ",
      "å¤©å§š": "å¤©å§š",
      "ç´…é¸": "ç´…é¸", "çº¢é¸¾": "ç´…é¸",
      "å¤©åˆ‘": "å¤©åˆ‘",
      "è§£ç¥": "è§£ç¥",
      "å¤©å¨": "å¤©å»š", "å¤©å»š": "å¤©å»š",
      "æˆªè·¯": "æˆªè·¯",
      "å­¤è¾°": "å­¤è¾°",
      "å¯¡å®¿": "å¯¡å®¿",
      "ç©ºäº¡": "ç©ºäº¡",
      "ç ´ç¢": "ç ´ç¢",
      "å¤©è´µ": "å¤©è²´", "å¤©è²´": "å¤©è²´",
      "åç›–": "è¯è“‹", "è¯è“‹": "è¯è“‹",
      "å¤©å“­": "å¤©å“­",
      "å¤©è™š": "å¤©è™›", "å¤©è™›": "å¤©è™›",
      "å¤©å¾·": "å¤©å¾·",
      "æœˆå¾·": "æœˆå¾·",
      "æ—¬ç©º": "æ—¬ç©º",
      "å°è¾…": "å°è¼”", "å°è¼”": "å°è¼”",
      "å°è¯°": "å°èª¥", "å°èª¥": "å°èª¥",
      "é¾™æ± ": "é¾æ± ", "é¾æ± ": "é¾æ± ",
      "å‡¤é˜": "é³³é–£", "é³³é–£": "é³³é–£",
      "å¹´è§£": "å¹´è§£",
      "å’¸æ± ": "å’¸æ± ",
      "ä¸‰å°": "ä¸‰å°",
      "å…«åº§": "å…«åº§",
      "æ©å…‰": "æ©å…‰",
      "èœšå»‰": "èœšå»‰",
      "é˜´ç…": "é™°ç…", "é™°ç…": "é™°ç…",
      "å¤©æœˆ": "å¤©æœˆ",
      "åšå£«": "åšå£«",
      "åŠ›å£«": "åŠ›å£«",
      "é’é¾": "é’é¾", "é’é¾™": "é’é¾",
      "å°è€—": "å°è€—",
      "å°‡è»": "å°‡è»", "å°†å†›": "å°‡è»",
      "å¥æ›¸": "å¥æ›¸", "å¥ä¹¦": "å¥æ›¸",
      "å–œç¥": "å–œç¥",
      "ç—…ç¬¦": "ç—…ç¬¦",
      "å¤§è€—": "å¤§è€—",
      "ä¼å…µ": "ä¼å…µ",
      "å®˜åºœ": "å®˜åºœ",
      "ç”²ç´šä¸»æ˜Ÿ": "ç”²ç´šä¸»æ˜Ÿ",
      "å…­å‰æ˜Ÿ": "å…­å‰æ˜Ÿ",
      "å…­ç…æ˜Ÿ": "å…­ç…æ˜Ÿ",
      "å—æ–—ã€åŒ—æ–—æ˜Ÿ": "å—æ–—ã€åŒ—æ–—æ˜Ÿ",
      "ä¸­å¤©æ˜Ÿ": "ä¸­å¤©æ˜Ÿ",
      "è¼”åŠ©æ˜Ÿ": "è¼”åŠ©æ˜Ÿ",
      "ç¥¿å­˜èˆ‡å¤©é¦¬": "ç¥¿å­˜èˆ‡å¤©é¦¬"
    };
    branches.forEach(b=>{
      const cg = CANGGAN_DATA[b.z] || null;
      const rows = cg ? Object.entries(cg)
        .sort((a,b)=> (b[1]||0)-(a[1]||0))
        .map(([stem,w])=>{
          const pct = Math.round((Number(w)||0)*100);
          return `<span class="inline-flex items-center gap-2 px-2 py-1 rounded-lg bg-black/30 border border-white/10 text-xs">
            <span class="font-black">${stem}</span><span class="text-slate-400">${pct}%</span>
          </span>`;
        }).join(" ")
        : `<span class="text-slate-500 italic text-xs">ï¼ˆç„¡è—å¹²è³‡æ–™ï¼‰</span>`;
      cgBox.innerHTML += `
        <div class="p-3 rounded-xl border border-white/10 bg-white/5">
          <div class="text-xs text-slate-400 mb-2">${b.label}ï¼š<span class="font-black text-slate-200">${b.z || "â€”"}</span></div>
          <div class="flex flex-wrap gap-2">${rows}</div>
        </div>
      `;
    });
  }
  // ====== RENDER: LIUYUE ======
  function renderLiuyue(bazi){
    const mGrid   = document.getElementById("monthGrid");
    const detail  = document.getElementById("monthDetailBox");
    const rhythm  = document.getElementById("monthlyRhythmBox");
    if (!mGrid || !rhythm) return;
    const bounds = bazi?.liuyue2026?.bounds || [];
    mGrid.innerHTML = "";
    rhythm.innerHTML = "";
    if (detail) detail.innerHTML = `
      <div class="text-slate-400/80">
        é»ä»»ä¸€å€‹æœˆä»½ï¼Œé€™è£¡æœƒé¡¯ç¤ºï¼šå°ä½ å€‹äººè€Œè¨€çš„
        <span class="text-amber-300 font-bold">å±éšªæŒ‡æ•¸ï¼‹è§¸ç™¼åŸå› ï¼‹æˆ°è¡“æŒ‡ä»¤</span>ã€‚
      </div>
    `;

    function toTraditionalStarName(name){
      return STAR_NAME_TRAD_MAP[name] || name;
    if (!bounds.length){
      mGrid.innerHTML = `<div class="text-xs text-slate-400 italic">ï¼ˆæš«ç„¡æµæœˆè³‡æ–™ï¼‰</div>`;
      if (detail){
        detail.innerHTML = `<div class="text-xs text-slate-400 italic">ï¼ˆæš«ç„¡æµæœˆè³‡æ–™ï¼‰</div>`;
      }
      return;
    }

    // äº”è¡Œ map ç”¨ã€Œç¹é«”æ˜Ÿåã€
    const STAR_WUXING_MAP = {
      "ç´«å¾®":"åœŸ","å¤©æ©Ÿ":"æœ¨","å¤ªé™½":"ç«","æ­¦æ›²":"é‡‘","å¤©åŒ":"æ°´",
      "å»‰è²":"ç«","å¤©åºœ":"åœŸ","å¤ªé™°":"æ°´","è²ªç‹¼":"æœ¨","å·¨é–€":"æ°´",
      "å¤©ç›¸":"æ°´","å¤©æ¢":"åœŸ","ä¸ƒæ®º":"é‡‘","ç ´è»":"æ°´",
    };
    bounds.forEach((b)=>{
      const isRed = b.light === "RED";
      const tag   = isRed ? "ğŸ”´ å£“åŠ›" : "ğŸŸ¢ ç©©é€²";

    // åœ°æ”¯è—å¹²ï¼ˆå‰ç«¯é¡¯ç¤ºç”¨ï¼‰
    const CANGGAN_DATA = {
      "å­": { "ç™¸": 1.0 },
      "ä¸‘": { "å·±": 0.6, "ç™¸": 0.3, "è¾›": 0.1 },
      "å¯…": { "ç”²": 0.6, "ä¸™": 0.3, "æˆŠ": 0.1 },
      "å¯": { "ä¹™": 1.0 },
      "è¾°": { "æˆŠ": 0.6, "ä¹™": 0.3, "ç™¸": 0.1 },
      "å·³": { "ä¸™": 0.6, "åºš": 0.3, "æˆŠ": 0.1 },
      "åˆ": { "ä¸": 0.7, "å·±": 0.3 },
      "æœª": { "å·±": 0.6, "ä¸": 0.3, "ä¹™": 0.1 },
      "ç”³": { "åºš": 0.6, "å£¬": 0.3, "æˆŠ": 0.1 },
      "é…‰": { "è¾›": 1.0 },
      "æˆŒ": { "æˆŠ": 0.6, "è¾›": 0.3, "ä¸": 0.1 },
      "äº¥": { "å£¬": 0.7, "ç”²": 0.3 },
    };
      // ä¸»åˆ—è¡¨å¡ç‰‡
      const card = document.createElement("button");
      card.type = "button";
      card.className =
        "w-full text-left flex flex-col gap-1 p-3 rounded-xl border-l-4 transition " +
        (isRed ? "border-red-500 bg-red-500/10 hover:bg-red-500/20"
               : "border-emerald-400 bg-emerald-500/10 hover:bg-emerald-500/20");

    const DEFAULT_WUXING_MEANINGS = {
      "æœ¨": { headline: "æˆé•·èˆ‡è¦åŠƒ", content: "æœ¨ä»£è¡¨ç”Ÿé•·ã€å»¶å±•ã€è¦åŠƒã€å­¸ç¿’èˆ‡äººéš›é€£çµã€‚æœ¨æ—ºå¤šä¸»ä¸»å‹•ã€é¡˜æ„æ¨é€²ï¼›æœ¨å¼±å¸¸éœ€è£œç­–ç•¥èˆ‡é•·æœŸå¸ƒå±€ã€‚" },
      "ç«": { headline: "èƒ½è¦‹åº¦èˆ‡å‹•èƒ½", content: "ç«ä»£è¡¨è¡¨é”ã€æ›å…‰ã€ç†±æƒ…ã€æ¨å‹•èˆ‡æ±ºç­–é€Ÿåº¦ã€‚ç«æ—ºæ˜“è¡éé ­ã€æƒ…ç·’æ±ºç­–ï¼›ç«å¼±å‰‡è¡Œå‹•èˆ‡è‡ªä¿¡ä¸è¶³ã€‚" },
      "åœŸ": { headline: "æ‰¿æ¥èˆ‡ç³»çµ±", content: "åœŸä»£è¡¨ç©©å®šã€å®¹å™¨ã€æµç¨‹ã€è¦ç¯„èˆ‡æŒä¹…åŠ›ã€‚åœŸæ—ºæ˜“æ²‰é‡ä¿å®ˆï¼›åœŸå¼±å‰‡é›£è½åœ°ã€ç¼ºä¹æ‰¿è¼‰ã€‚" },
      "é‡‘": { headline: "çµæ§‹èˆ‡ç•Œç·š", content: "é‡‘ä»£è¡¨è¦å‰‡ã€åˆ‡å‰²ã€æ•ˆç‡ã€æ¨™æº–èˆ‡é¢¨éšªæ§åˆ¶ã€‚é‡‘æ—ºå®¹æ˜“è‹›åˆ»ã€å£“è¿«ï¼›é‡‘å¼±å‰‡ç•Œç·šé¬†æ•£ã€åŸ·è¡Œæ¨™æº–ä¸ç©©ã€‚" },
      "æ°´": { headline: "æµå‹•èˆ‡æ´å¯Ÿ", content: "æ°´ä»£è¡¨è³‡è¨Šã€è³‡æºæµå‹•ã€æ´å¯Ÿèˆ‡é©æ‡‰ã€‚æ°´æ—ºå¸¸å¤šæƒ³å¤šè®Šï¼›æ°´å¼±å‰‡è¦–é‡è®Šçª„ã€è³‡æºèª¿åº¦ä¸é †ã€‚" },
    };
      card.innerHTML = `
        <div class="flex items-center justify-between">
          <div>
            <div class="font-black text-sm text-slate-50">
              ${b.gz}
              <span class="text-[10px] text-slate-300 ml-2 font-mono">${b.range || ""}</span>
            </div>
            <div class="text-[11px] text-slate-200 mt-1">
              åç¥ï¼šå¹² ${b.ssStem || "â€”"} ï¼ æ”¯ ${b.ssBranch || "â€”"}
            </div>
          </div>
          <div class="text-right">
            <div class="text-[11px] font-black px-3 py-1 rounded-full bg-black/40">
              ${tag}
            </div>
            <div class="text-[10px] text-slate-400 mt-1">
              å±éšªæŒ‡æ•¸ï¼š
              <span class="${isRed ? "text-red-300" : "text-emerald-300"} font-mono">
                ${b.riskScore ?? "â€”"}
              </span> / 100
            </div>
          </div>
        </div>
      `;

    // ====== STATE ======
    let dbContent = { palaces:{}, stars:{}, tenGods:{}, wuxing:{} };
    let contract = null;
    let selectedPalace = "å‘½å®®";
    // ====== HELPERS ======
    function pad2(n){ return String(n).padStart(2,"0"); }
    function getStarsForPalace(ziwei, palaceName){
      if (!ziwei || !ziwei.mainStars) return [];
      const keys = PALACE_KEY_MAP[palaceName] || [palaceName];
      const all = [];
      keys.forEach(k=>{
        const list = ziwei.mainStars[k];
        if (Array.isArray(list)) list.forEach(s => all.push(s));
      });
      return all;
    }
      // é»æŸæœˆ â†’ åœ¨ä¸‹é¢ monthDetailBox é¡¯ç¤ºå€‹æ€§åŒ–åŸå› ï¼‹æˆ°è¡“
      card.addEventListener("click", () => {
        if (!detail) return;
        const reasons = (b.reasonTags || []).join("ï¼");

    // ===== renderBarï¼šåŠ å‹•ç•«ç‰ˆ =====
    function renderBar(targetId, data, max){
      const box = document.getElementById(targetId);
      if (!box) return;
      box.innerHTML = "";
      ["æœ¨","ç«","åœŸ","é‡‘","æ°´"].forEach((e, index)=>{
        const v = Number(data?.[e] || 0);
        const w = max ? Math.max(3, (v / max) * 100) : 0;
        const barId = `${targetId}-${e}`;
        box.innerHTML += `
          <div class="mb-1 wx-row" style="animation-delay:${index * 0.06}s">
            <div class="flex justify-between text-xs text-slate-300">
              <span class="font-bold">${e}</span>
              <span class="font-mono">${v.toFixed(1)}</span>
        detail.innerHTML = `
          <div class="p-4 rounded-xl border ${isRed ? "border-red-400/60 bg-red-500/10" : "border-emerald-400/60 bg-emerald-500/10"} text-sm leading-relaxed space-y-2">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-[11px] uppercase tracking-[0.18em] text-slate-300">Personalized Month Radar</div>
                <div class="font-black text-base text-slate-50 mt-1">
                  ${b.gz}ï¼ˆ${b.range}ï¼‰
                </div>
              </div>
              <div class="text-right text-[11px] text-slate-200">
                å±éšªæŒ‡æ•¸
                <div class="text-lg font-mono ${isRed ? "text-red-300" : "text-emerald-300"}">
                  ${b.riskScore ?? "â€”"}/100
                </div>
              </div>
            </div>
            <div class="h-2 bg-white/10 rounded overflow-hidden">
              <div class="h-full wuxing-${e} wx-bar-inner" style="width:0%" id="${barId}"></div>
            <div class="text-[11px] text-slate-200">
              å€‹æ€§åŒ–è§¸ç™¼ï¼š
              <span class="text-slate-100">${reasons || "ï¼ˆå°šæœªæ¨™è¨»è§¸ç™¼åŸå› ï¼‰"}</span>
            </div>
            <div class="text-[11px] text-amber-100 mt-1">
              æˆ°è¡“æŒ‡ä»¤ï¼š
              <span class="text-amber-50">${b.strategy || "ï¼ˆå°šæœªæ’°å¯«æˆ°è¡“å»ºè­°ï¼‰"}</span>
            </div>
          </div>
        `;
        setTimeout(()=>{
          const bar = document.getElementById(barId);
          if (bar) bar.style.width = `${w}%`;
        }, 50 + index*40);
        detail.scrollIntoView({ behavior:"smooth", block:"nearest" });
      });
    }

    function pctFromWx(wx){
      const total = Object.values(wx||{}).reduce((s,v)=>s+(Number(v)||0),0) || 1;
      const pct = {};
      ["æœ¨","ç«","åœŸ","é‡‘","æ°´"].forEach(k => pct[k] = (Number(wx?.[k]||0)/total));
      return { total, pct };
      mGrid.appendChild(card);
      // å³å´ã€Œ2026 æµæœˆç¯€å¥ï¼ˆå¿«é€Ÿåƒè€ƒï¼‰ã€ï¼šåŒæ™‚é¡¯ç¤º riskScore
      rhythm.innerHTML += `
        <div class="flex items-center justify-between p-3 rounded-xl bg-white/5 border border-white/10">
          <div class="flex items-center">
            <span class="month-dot ${isRed ? "bg-red-light" : "bg-green-light"}"></span>
            <span class="text-[11px] font-black text-slate-200">${b.gz}</span>
            <span class="text-[9px] text-slate-500 ml-2 font-mono">${b.range || ""}</span>
          </div>
          <div class="text-right">
            <div class="text-[10px] font-black ${isRed ? "text-red-300" : "text-emerald-300"}">
              ${isRed ? "å®ˆè¦å‰‡" : "æ¨é€²"}
            </div>
            <div class="text-[9px] text-slate-400">å±éšª ${b.riskScore ?? "â€”"}</div>
          </div>
        </div>
      `;
    });
  }
  // ====== Mobile Bottom Sheet æ§åˆ¶ ======
  function openPalaceSheet(){
    const sheet = document.getElementById("palaceSheet");
    const backdrop = document.getElementById("palaceSheetBackdrop");
    if (!sheet) return;
    sheet.classList.add("open");
    if (backdrop) backdrop.classList.remove("hidden");
    document.body.style.overflow = "hidden";
  }
  function closePalaceSheet(){
    const sheet = document.getElementById("palaceSheet");
    const backdrop = document.getElementById("palaceSheetBackdrop");
    if (!sheet) return;
    sheet.classList.remove("open");
    if (backdrop) backdrop.classList.add("hidden");
    document.body.style.overflow = "";
  }
  // â­ æ–°å¢ï¼šä¾ã€Œå‘½å®®åœ°æ”¯ã€ï¼‹å›ºå®š PALACE_DEFAULT â†’ ç®—å‡ºæ¯ä¸€æ ¼è¦æ”¾å“ªå€‹å®®ä½
  function buildSlotsFromZiwei(ziwei){
    if (!ziwei) return [];
    const mingBranch = ziwei?.core?.minggongBranch || "å¯…";
    const shenBranch = ziwei?.core?.shengongBranch || null;
    const mingIdx = BRANCH_RING.indexOf(mingBranch);
    const palaceOrder = PALACE_DEFAULT; // å‘½ã€å…„ã€å¤«ã€å­â€¦ é€™å€‹é †åºæ˜¯å›ºå®šçš„ã€Œå®®ä½é‚è¼¯ã€
    return BRANCH_RING.map((branch, idx) => {
      // è®“ã€Œå‘½å®®ã€å°é½Šå‘½å®®åœ°æ”¯æ‰€åœ¨çš„é‚£ä¸€æ ¼ï¼Œå…¶é¤˜å®®ä½ç…§é€†è¡Œé †åºæ’
      const palaceIndex = (mingIdx - idx + 12) % 12;
      const palaceName  = palaceOrder[palaceIndex];
      const rawStars = getStarsForPalace(ziwei, palaceName);
      const stars = rawStars.map(toTraditionalStarName);
      let palaceMainElement = "";
      if (stars.length){
        palaceMainElement = STAR_WUXING_MAP[stars[0]] || "";
      }
      return {
        index: idx,
        branch,
        palaceName,
        stars,
        isMing: branch === mingBranch,
        isShen: shenBranch ? branch === shenBranch : false,
        mainElement: palaceMainElement,
      };
    });
  }
  // ====== RENDER: ZIWEI GRIDï¼ˆä¿®æ­£ç‰ˆï¼‰ ======
  function renderZiwei(ziwei){
    const container = document.getElementById("ziweiGrid");
    const hint = document.getElementById("ziweiHint");
    if (!container) return;
    container.innerHTML = "";
    if (!ziwei){
      container.innerHTML = `
        <div class="col-span-4 flex items-center justify-center text-xs text-slate-500 text-center">
          ç´«å¾®è³‡æ–™æš«ä¸å¯ç”¨ï¼ˆå¾Œç«¯ iztro å‡ºéŒ¯æˆ–æœªå›å‚³ï¼‰ã€‚è«‹ç¨å¾Œé‡è©¦ã€‚
        </div>`;
      if (hint) hint.textContent = "";
      return;
    }

    // ====== å…¶é¤˜ Bazi / æµæœˆ / Tactical å‡½å¼ =====
    // ï¼ˆé€™éƒ¨åˆ†ä¿ç•™ä½ åŸæœ¬é‚è¼¯ï¼Œåªç•¥æ‰é‡è¤‡è²¼æ–‡ï¼Œä»¥å…å¤ªé•·ï¼‰
    // â€¦â€¦ é€™è£¡é–‹å§‹åˆ° renderLiuyueã€computeDynamicTactics ç­‰éƒ½ç¶­æŒåŸå…ˆå…§å®¹ â€¦â€¦
    // ====== RENDER: ZIWEI GRID ======
    function renderZiwei(ziwei){
      const container = document.getElementById("ziweiGrid");
      const meta = document.getElementById("ziweiMeta");
      const hint = document.getElementById("ziweiHint");
      if (!container) return;
      container.innerHTML = "";
      if (!ziwei){
        container.innerHTML = `
          <div class="col-span-4 flex items-center justify-center text-xs text-slate-500 text-center">
            ç´«å¾®è³‡æ–™æš«ä¸å¯ç”¨ï¼ˆå¾Œç«¯ iztro å‡ºéŒ¯æˆ–æœªå›å‚³ï¼‰ã€‚è«‹ç¨å¾Œé‡è©¦ã€‚
          </div>`;
        if (meta) meta.textContent = "";
        if (hint) hint.textContent = "";
        return;
    const slots = buildSlotsFromZiwei(ziwei);
    slots.forEach((slot) => {
      const isKey = ["å‘½å®®","å®˜ç¥¿","è²¡å¸›"].includes(slot.palaceName);
      const glowClass = slot.mainElement ? `palace-glow-${slot.mainElement}` : "";
      const starsHtml = slot.stars.length
        ? slot.stars.map(s=>{
            const wx = STAR_WUXING_MAP[s] || "";
            return `<span class="${wx ? "star-wx-"+wx : ""}">${s}</span>`;
          }).join("<br>")
        : `<span class="text-slate-600 text-xs italic font-normal">ç©ºå®®</span>`;
      let title = slot.palaceName;
      if (slot.isMing && slot.isShen) {
        title += "ï¼ˆå‘½èº«åŒå®®ï¼‰";
      } else if (slot.isMing) {
        title += "ï¼ˆå‘½ï¼‰";
      } else if (slot.isShen) {
        title += "ï¼ˆèº«ï¼‰";
      }

      // é€™è£¡æ”¹ç”¨å›ºå®š PALACE_RINGï¼ˆä¸åƒå¾Œç«¯é †é€†ï¼‰
      PALACE_RING.forEach((name, idx)=>{
        const rawStars = getStarsForPalace(ziwei, name);
        const stars = rawStars.map(toTraditionalStarName);
        const isKey = ["å‘½å®®","å®˜ç¥¿","è²¡å¸›"].includes(name);
      const el = document.createElement("div");
      el.className = `zw-palace ${isKey ? "zw-palace-key" : ""} ${glowClass}`;
      el.style.gridArea = gridAreas[slot.index];
      el.setAttribute("data-palace-name", slot.palaceName);

        let palaceMainElement = "";
        if (stars.length){
          palaceMainElement = STAR_WUXING_MAP[stars[0]] || "";
        }
        const glowClass = palaceMainElement ? `palace-glow-${palaceMainElement}` : "";
        const starsHtml = stars.length
          ? stars.map(s=>{
              const wx = STAR_WUXING_MAP[s] || "";
              return `<span class="${wx ? "star-wx-"+wx : ""}">${s}</span>`;
            }).join("<br>")
          : `<span class="text-slate-600 text-xs italic font-normal">ç©ºå®®</span>`;
        const el = document.createElement("div");
        el.className = `zw-palace ${isKey ? "zw-palace-key" : ""} ${glowClass}`;
        el.style.gridArea = gridAreas[idx];
        el.innerHTML = `
          <div class="text-[10px] font-black text-slate-500 mb-1">${name}</div>
          <div class="text-[13px] font-black leading-snug tracking-wide">${starsHtml}</div>
        `;
        el.addEventListener("click", ()=>{
          selectPalace(name);
          if (window.innerWidth <= 768){
            openPalaceSheet();
          } else {
            document.getElementById("detailPanel").scrollIntoView({ behavior:"smooth", block:"start" });
          }
        });
      el.innerHTML = `
        <div class="text-[10px] font-black text-slate-500 mb-1">
          ${title}
        </div>
        <div class="text-[11px] text-slate-400 mb-1">
          ${slot.branch}å®®
        </div>
        <div class="text-[13px] font-black leading-snug tracking-wide">
          ${starsHtml}
        </div>
      `;
      el.addEventListener("click", ()=>{
        selectPalace(slot.palaceName);

        container.appendChild(el);
        if (window.innerWidth <= 768){
          openPalaceSheet();
        } else {
          document.getElementById("detailPanel").scrollIntoView({ behavior:"smooth", block:"start" });
        }
      });

      const center = document.createElement("div");
      center.className = "zw-center-block";
      center.innerHTML = `
        <div class="text-[10px] tracking-[0.18em] text-slate-500 font-black">DESTINY CORE</div>
        <div class="text-amber-400 font-black text-xl tracking-widest mt-1">${ziwei.core?.minggong || "â€”"}</div>
        <div class="text-[11px] text-slate-300 mt-1">èº«ä¸»ï¼š${ziwei.core?.shengong || "â€”"}</div>
        <div class="text-[11px] text-slate-400 mt-1">äº”è¡Œå±€ï¼š${ziwei.core?.wuxingju || "â€”"}</div>
      `;
      container.appendChild(center);
      container.appendChild(el);
    });

      if (meta) meta.textContent = `å‘½å®®ï¼š${ziwei.core?.minggong || "â€”"}ï½œäº”è¡Œå±€ï¼š${ziwei.core?.wuxingju || "â€”"}`;
      if (hint) hint.innerHTML = `æç¤ºï¼šä¸‰æ–¹å››æ­£ï¼æœ¬å®®ï¼‹å°å®®ï¼‹ä¸‰åˆå…©å®®ï¼ˆé»å®®ä½è‡ªå‹•æ¨™ç¤ºï¼‰ã€‚`;
    // ä¸­å¤® core
    const center = document.createElement("div");
    center.className = "zw-center-block";
    const core = ziwei.core || {};
    center.innerHTML = `
      <div class="text-[10px] tracking-[0.18em] text-slate-500 font-black">DESTINY CORE</div>
      <div class="text-amber-400 font-black text-xl tracking-widest mt-1">${core.minggong || "â€”"}</div>
      <div class="text-[11px] text-slate-300 mt-1">
        èº«ä¸»ï¼š${core.shengong || "â€”"}
      </div>
      <div class="text-[11px] text-slate-400 mt-1">
        äº”è¡Œå±€ï¼š${core.wuxingju || "â€”"}
      </div>
      <div class="text-[10px] text-slate-500 mt-1">
        å‘½å®®æ”¯ï¼š${core.minggongBranch || "â€”"} ï½œ èº«å®®æ”¯ï¼š${core.shengongBranch || "â€”"}
      </div>
    `;
    container.appendChild(center);
    if (hint) {
      hint.innerHTML = `æç¤ºï¼šå‘½å®®ä½ç½®æœƒä¾å‘½å®®åœ°æ”¯æ—‹è½‰æ’ç›¤ï¼›ä¸‰æ–¹å››æ­£ï¼æœ¬å®®ï¼‹å°å®®ï¼‹ä¸‰åˆå…©å®®ï¼ˆé»å®®ä½è‡ªå‹•æ¨™ç¤ºï¼‰ã€‚`;
    }
  }
  // ====== Palace Detail (DB-driven) ======
  function selectPalace(name){
    selectedPalace = name;
    // ä¸‰æ–¹å››æ­£ï¼šæœ¬å®® + å°å®®( +6 ) + ä¸‰åˆ( +4, +8 )ï¼Œç”¨ã€Œå®®ä½ç’°ã€è¨ˆç®—
    const idx = PALACE_RING.indexOf(name);
    const relatedIdx = new Set([idx, (idx+6)%12, (idx+4)%12, (idx+8)%12]);
    const relatedNames = new Set(Array.from(relatedIdx).map(i => PALACE_RING[i]));
    // ç”¨ data-palace-name ä¾†å° DOM æ¨™è¨˜ active / relatedï¼ˆä¸å†ä¾è³´ DOM indexï¼‰
    document.querySelectorAll(".zw-palace").forEach((el)=>{
      const pName = el.getAttribute("data-palace-name") || "";
      el.classList.remove("is-active","is-related");
      if (pName === name) el.classList.add("is-active");
      else if (relatedNames.has(pName)) el.classList.add("is-related");
    });

    function selectPalace(name){
      selectedPalace = name;
    const ziwei = contract?.ziwei;
    const rawStars = ziwei ? getStarsForPalace(ziwei, name) : [];
    const stars = rawStars.map(toTraditionalStarName);
    const titleText = `2026 ${name} Â· ä½œæˆ°é¢æ¿`;
    const subText   = `ä¸‰æ–¹å››æ­£å·²æ¨™ç¤ºï¼šæœ¬å®®ï¼‹å°å®®ï¼‹ä¸‰åˆï¼ˆå…±å››å®®ï¼‰ã€‚`;
    // desktop header
    document.getElementById("palaceTitle").textContent = titleText;
    document.getElementById("palaceSub").textContent   = subText;
    const palaceText = (dbContent.palaces && dbContent.palaces[name])
      ? dbContent.palaces[name]
      : "ï¼ˆè³‡æ–™åº«å°šæœªå¡«å…¥æ­¤å®®ä½è§£é‡‹ï¼‰";
    let starCards = "";
    if (stars.length){
      starCards = stars.map(s=>{
        const wx = STAR_WUXING_MAP[s] || "";
        const explain = (dbContent.stars && dbContent.stars[s])
          ? dbContent.stars[s]
          : "ï¼ˆè³‡æ–™åº«å°šæœªå¡«å…¥æ­¤æ˜Ÿæ›œè§£é‡‹ï¼‰";
        return `
          <div class="p-4 rounded-xl border border-white/10 bg-white/5">
            <div class="flex items-center justify-between gap-3">
              <div class="font-black text-base ${wx ? "star-wx-"+wx : "text-slate-200"}">ã€${s}ã€‘</div>
              <div class="text-[10px] text-slate-500">${wx ? "äº”è¡Œï¼š"+wx : ""}</div>
            </div>
            <div class="text-xs text-slate-300 mt-2 leading-relaxed">${explain}</div>
          </div>
        `;
      }).join("");
    } else {
      starCards = `
        <div class="p-4 rounded-xl border border-white/10 bg-white/5">
          <div class="text-sm text-slate-300 font-black">ç©ºå®®</div>
          <div class="text-xs text-slate-400 mt-2">ç©ºå®®ä¸ç­‰æ–¼æ²’æœ‰äº‹ä»¶ï¼Œé‡é»æ˜¯çœ‹ä¸‰æ–¹å››æ­£èˆ‡æµæœˆç¯€å¥å¦‚ä½•å¼•å‹•ã€‚</div>
        </div>
      `;
    }

      // ä¸‰æ–¹å››æ­£ï¼šæœ¬å®® + å°å®®( +6 ) + ä¸‰åˆ( +4, +8 )ï¼Œç”¨å›ºå®š PALACE_RING
      const idx = PALACE_RING.indexOf(name);
      const related = new Set([idx, (idx+6)%12, (idx+4)%12, (idx+8)%12]);
    const detailHtml = `
      <div class="p-4 rounded-xl border border-amber-400/25 bg-amber-500/10">
        <div class="text-[10px] text-amber-200 font-black tracking-widest uppercase mb-2">è³‡æ–™åº«å®®ä½è§£é‡‹</div>
        <div class="text-sm text-slate-100 leading-relaxed">${palaceText}</div>
      </div>
      document.querySelectorAll(".zw-palace").forEach((el, i)=>{
        el.classList.remove("is-active","is-related");
        if (i === idx) el.classList.add("is-active");
        else if (related.has(i)) el.classList.add("is-related");
      <div>
        <div class="text-[10px] text-slate-500 font-black tracking-widest uppercase mb-3">æ˜Ÿæ›œè§£é‡‹ï¼ˆè³‡æ–™åº«ï¼‰</div>
        <div class="space-y-3">${starCards}</div>
      </div>
    `;
    // desktop body
    const body = document.getElementById("palaceDetailBody");
    body.innerHTML = detailHtml;
    // mobile bottom sheet åŒæ­¥
    const mTitle = document.getElementById("mobilePalaceTitle");
    const mSub   = document.getElementById("mobilePalaceSub");
    const mBody  = document.getElementById("mobilePalaceBody");
    if (mTitle) mTitle.textContent = titleText;
    if (mSub)   mSub.textContent   = subText;
    if (mBody)  mBody.innerHTML    = detailHtml;
  }
  // ====== Load DB Content ======
  async function loadDbContent(){
    try{
      const r = await fetch(`${API_BASE}/content/2026`, { method:"GET" });
      const j = await r.json();
      if (j?.ok){
        dbContent = j;
      }
    }catch(e){
      console.warn("loadDbContent failed", e);
    }finally{
      renderWuxingMeaningBox();
    }
  }
  // ====== Calculate ======
  async function calculate(){
    const btn  = document.getElementById("btnLaunch");
    const hint = document.getElementById("hint");
    const original = btn.textContent;
    const vy = Number(document.getElementById("birthYear").value);
    const vm = Number(document.getElementById("birthMonth").value);
    const vd = Number(document.getElementById("birthDay").value);
    const vh = Number(document.getElementById("birthHour").value);
    const vmin = Number(document.getElementById("birthMinute").value);
    try{
      if (![vy,vm,vd,vh,vmin].every(n=>Number.isFinite(n))) {
        throw new Error("è«‹å…ˆé¸å®Œæ•´å‡ºç”Ÿè³‡æ–™");
      }
      btn.disabled = true;
      btn.textContent = "è¨ˆç®—ä¸­â€¦";
      hint.textContent = "æ­£åœ¨é€£ç·šå¾Œç«¯è¨ˆç®—ï¼ˆå…«å­—ï¼‹ç´«å¾®ï¼‹æµæœˆï¼‹åç¥ï¼‰â€¦";
      const resp = await fetch(`${API_BASE}/compute/all`, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ year:vy, month:vm, day:vd, hour:vh, minute:vmin })
      });

      // ä¸‹æ–¹è©³è§£ï¼ˆä¿æŒä½ åŸæœ¬çš„å…§å®¹ï¼‰
      const ziwei = contract?.ziwei;
      const rawStars = ziwei ? getStarsForPalace(ziwei, name) : [];
      const stars = rawStars.map(toTraditionalStarName);
      if (!resp.ok){
        const t = await resp.text().catch(()=> "");
        throw new Error(`API HTTP ${resp.status} ${t}`.trim());
      }
      const payload = await resp.json();
      console.log("compute/all payload:", payload);
      console.log("chartId from payload:", payload.chartId);

      const titleText = `2026 ${name} Â· ä½œæˆ°é¢æ¿`;
      const subText   = `ä¸‰æ–¹å››æ­£å·²æ¨™ç¤ºï¼šæœ¬å®®ï¼‹å°å®®ï¼‹ä¸‰åˆï¼ˆå…±å››å®®ï¼‰ã€‚`;
      if (!payload?.ok) throw new Error(payload?.error || "API error");

      document.getElementById("palaceTitle").textContent = titleText;
      document.getElementById("palaceSub").textContent   = subText;
      contract = payload.features;
      if (!contract || contract.version !== "strategic_features_v1"){
        throw new Error("features æ ¼å¼éŒ¯èª¤ï¼ˆä¸æ˜¯ strategic_features_v1ï¼‰");
      }

      const palaceText = (dbContent.palaces && dbContent.palaces[name]) ? dbContent.palaces[name] : "ï¼ˆè³‡æ–™åº«å°šæœªå¡«å…¥æ­¤å®®ä½è§£é‡‹ï¼‰";
      const chartId = payload.chartId || contract.chartId || null;
      const bazi = contract.bazi;
      const ziwei = contract.ziwei;

      let starCards = "";
      if (stars.length){
        starCards = stars.map(s=>{
          const wx = STAR_WUXING_MAP[s] || "";
          const explain = (dbContent.stars && dbContent.stars[s]) ? dbContent.stars[s] : "ï¼ˆè³‡æ–™åº«å°šæœªå¡«å…¥æ­¤æ˜Ÿæ›œè§£é‡‹ï¼‰";
          return `
            <div class="p-4 rounded-xl border border-white/10 bg-white/5">
              <div class="flex items-center justify-between gap-3">
                <div class="font-black text-base ${wx ? "star-wx-"+wx : "text-slate-200"}">ã€${s}ã€‘</div>
                <div class="text-[10px] text-slate-500">${wx ? "äº”è¡Œï¼š"+wx : ""}</div>
              </div>
              <div class="text-xs text-slate-300 mt-2 leading-relaxed">${explain}</div>
            </div>
          `;
        }).join("");
      if (!bazi) throw new Error("å¾Œç«¯æœªå›å‚³ bazi");
      let ziweiScores = null;
      if (chartId) {
        try {
          const scoreResp = await fetch(
            `${API_BASE}/charts/${encodeURIComponent(chartId)}/scores`,
            { method: "GET" }
          );
          if (scoreResp.ok) {
            ziweiScores = await scoreResp.json();
            window.ziweiScores = ziweiScores; // debug
            console.log("ziweiScores from API:", ziweiScores);
          } else {
            console.warn("scores API HTTP", scoreResp.status, await scoreResp.text().catch(()=> ""));
          }
        } catch (err) {
          console.warn("scores API error:", err);
        }
      } else {
        starCards = `
          <div class="p-4 rounded-xl border border-white/10 bg-white/5">
            <div class="text-sm text-slate-300 font-black">ç©ºå®®</div>
            <div class="text-xs text-slate-400 mt-2">ç©ºå®®ä¸ç­‰æ–¼æ²’æœ‰äº‹ä»¶ï¼Œé‡é»æ˜¯çœ‹ä¸‰æ–¹å››æ­£èˆ‡æµæœˆç¯€å¥å¦‚ä½•å¼•å‹•ã€‚</div>
          </div>
        `;
        console.warn("No chartId in payload, scores API ç„¡æ³•å‘¼å«");
      }

      const detailHtml = `
        <div class="p-4 rounded-xl border border-amber-400/25 bg-amber-500/10">
          <div class="text-[10px] text-amber-200 font-black tracking-widest uppercase mb-2">è³‡æ–™åº«å®®ä½è§£é‡‹</div>
          <div class="text-sm text-slate-100 leading-relaxed">${palaceText}</div>
        </div>
        <div>
          <div class="text-[10px] text-slate-500 font-black tracking-widest uppercase mb-3">æ˜Ÿæ›œè§£é‡‹ï¼ˆè³‡æ–™åº«ï¼‰</div>
          <div class="space-y-3">${starCards}</div>
        </div>
      `;
      // â— å®®ä½ç’°ï¼šç¶­æŒå›ºå®šçš„ã€Œå‘½ã€å…„ã€å¤«ã€å­â€¦ã€é †åºï¼Œä¸å†ç”¨å¾Œç«¯è¦†è“‹
      PALACE_RING = PALACE_DEFAULT.slice();

      document.getElementById("palaceDetailBody").innerHTML = detailHtml;
      // ===== é€²å…¥ç³»çµ± UI =====
      const sysEl   = document.getElementById("system");
      const navEl   = document.getElementById("workspaceNav");
      const navCta  = document.getElementById("navCta");
      const inputEl = document.getElementById("inputCard");
      if (sysEl)   sysEl.classList.remove("hidden");
      if (navEl)   navEl.classList.remove("hidden");
      if (navCta)  navCta.classList.remove("hidden");
      if (inputEl) inputEl.classList.add("hidden");
      // summary
      const summaryBirthEl     = document.getElementById("summaryBirth");
      const summaryDMEl        = document.getElementById("summaryDM");
      const summaryDominantEl  = document.getElementById("summaryDominant");
      const summaryRedMonthsEl = document.getElementById("summaryRedMonths");
      if (summaryBirthEl) {
        summaryBirthEl.textContent =
          `${vy}/${pad2(vm)}/${pad2(vd)} Â· ${pad2(vh)}:${pad2(vmin)}ï¼ˆå…¬æ›†ï¼‰`;
      }
      if (summaryDMEl) {
        summaryDMEl.textContent = bazi.dmElement || "â€”";
      }
      if (summaryDominantEl) {
        summaryDominantEl.textContent =
          (bazi.tenGod?.dominant || "â€”").trim() || "â€”";
      }
      if (summaryRedMonthsEl) {
        const reds = bazi.liuyue2026?.redMonths || [];
        summaryRedMonthsEl.textContent =
          reds.length ? reds.join("ã€") : "åå°‘ï¼ˆå¯ç©©æ¨ï¼‰";
      }

      const mTitle = document.getElementById("mobilePalaceTitle");
      const mSub   = document.getElementById("mobilePalaceSub");
      const mBody  = document.getElementById("mobilePalaceBody");
      if (mTitle) mTitle.textContent = titleText;
      if (mSub)   mSub.textContent   = subText;
      if (mBody)  mBody.innerHTML    = detailHtml;
      // bazi + canggan + bars
      renderPillars(bazi);
      renderBar("surfaceWx", bazi.wuxing?.surface, 4);
      renderBar("strategicWx", bazi.wuxing?.strategic, bazi.wuxing?.maxStrategic || 1);
      // tenGod command box (DB first)
      const dominant = (bazi.tenGod?.dominant || "").trim();
      const cmd = dominant && dbContent.tenGods?.[dominant] ? dbContent.tenGods[dominant] : "";
      document.getElementById("tenGodCommand").textContent =
        cmd || `ï¼ˆè³‡æ–™åº«å°šæœªå¡«å…¥ã€Œ${dominant || "â€”"}ã€çš„åç¥æŒ‡ä»¤ã€‚ä½ å¯ä»¥å…ˆåœ¨ ten_god_analysis è£œä¸Š 2026 å…§å®¹ã€‚ï¼‰`;
      // liuyue
      renderLiuyue(bazi);
      // ziwei grid
      renderZiwei(ziwei);
      // ç´«å¾®åˆ†æ•¸
      if (ziweiScores && ziweiScores.palaceScores) {
        renderZiweiScores(ziweiScores);
      } else {
        const palaceBox = document.getElementById("ziweiPalaceScores");
        if (palaceBox) {
          palaceBox.innerHTML =
            `<div class="text-xs text-slate-400">ï¼ˆæš«ç„¡åˆ†æ•¸è³‡æ–™ï¼‰</div>`;
        }
        renderBar("ziweiWx", { æœ¨:0, ç«:0, åœŸ:0, é‡‘:0, æ°´:0 }, 1);
      }
      // tactical panel
      const tactics = computeDynamicTactics(bazi);
      const tacticalBox = document.getElementById("tacticalBox");
      tacticalBox.innerHTML = tactics.length
        ? tactics.map(x => `<div class="p-4 rounded-xl border ${toneClass(x.tone)} text-sm leading-relaxed">${x.text}</div>`).join("")
        : `<div class="text-sm text-slate-400 italic">ï¼ˆæˆ°è¡“æç¤ºæš«ä¸å¯ç”¨ï¼‰</div>`;
      // default select å‘½å®®
      if (ziwei){
        selectPalace("å‘½å®®");
      } else {
        document.getElementById("palaceTitle").textContent = "ç´«å¾®æš«ä¸å¯ç”¨";
        document.getElementById("palaceDetailBody").innerHTML = `<div class="p-4 rounded-xl border border-white/10 bg-white/5 text-sm text-slate-300">
          å¾Œç«¯ iztro å¯èƒ½å‡ºéŒ¯ï¼ˆæˆ–æ‰“åŒ…å•é¡Œï¼‰ã€‚è«‹å…ˆç¢ºèª worker build/ä¾è³´ï¼Œå†é‡è©¦ã€‚
        </div>`;
      }
      document.getElementById("ws-summary").scrollIntoView({ behavior:"smooth", block:"start" });
    }catch(e){
      console.error(e);
      alert("ç³»çµ±å¿™ç¢Œä¸­æˆ–è³‡æ–™æœ‰èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚\n\nè©³ç´°ï¼š" + (e?.message || e));
    }finally{
      btn.disabled = false;
      btn.textContent = original;
      hint.textContent = "";
    }
  }

    // ====== loadDbContent / calculate / renderLiuyue / tacticals =====
    // é€™äº›é‚è¼¯ä½ åŸæœ¬å°± OKï¼Œæˆ‘å°±ä¸å…¨éƒ¨é‡è²¼äº†ï¼Œåªä¿ç•™ä¸€å€‹é—œéµæ”¹å‹•ï¼š
  function renderZiweiScores(scores){
    const palaceBox = document.getElementById("ziweiPalaceScores");
    const wuxingBox = document.getElementById("ziweiWuxingScores");

    async function calculate(){
      // ... å‰åŠæ®µç¶­æŒä½ åŸæœ¬çš„ï¼ˆå–ç”Ÿæ—¥ã€å‘¼å« /compute/all ç­‰ï¼‰ ...
    if (!palaceBox || !wuxingBox) {
      console.warn("ziwei score boxes not found in DOM");
      return;
    }

      // å–å¾— features å¾Œï¼š
      // contract = payload.features; ä¹‹é¡
      // const bazi = contract.bazi;
      // const ziwei = contract.ziwei;
    console.log("[renderZiweiScores] raw scores =", scores);

      // âœ… é€™ä¸€ç‰ˆä¸å†ç”¨å¾Œç«¯ palaceRing ä¾†æ±ºå®šç›¤é¢æ–¹å‘ï¼Œç›´æ¥å›ºå®š
      PALACE_RING = PALACE_DEFAULT.slice();
    // 1ï¸âƒ£ å®®ä½å¼·åº¦ï¼šä¾åˆ†æ•¸æ’åº
    const entries = Object.entries(scores?.palaceScores || {});
    console.log("[renderZiweiScores] palace entries =", entries);

      // ä¸‹é¢ç…§èˆŠï¼šrenderPillars / renderBar / renderLiuyue / renderZiwei / selectPalace ç­‰
    const sortedPalaces = entries.sort((a, b) => Number(b[1]) - Number(a[1]));
    if (!sortedPalaces.length) {
      palaceBox.innerHTML =
        `<div class="text-xs text-slate-400">ï¼ˆå°šæœªè¨ˆç®—å®®ä½æ¬Šé‡ï¼‰</div>`;
    } else {
      palaceBox.innerHTML = sortedPalaces.map(([name, val]) => {
        const n = Number(val) || 0;
        return `
          <div class="flex justify-between text-xs py-1 border-b border-white/5">
            <span class="text-slate-300">${name}</span>
            <span class="text-slate-100 font-mono">${n.toFixed(2)}</span>
          </div>
        `;
      }).join("");
    }

    // ====== BOOT ======
    function initSelectors(){
      const y   = document.getElementById("birthYear");
      const m   = document.getElementById("birthMonth");
      const d   = document.getElementById("birthDay");
      const h   = document.getElementById("birthHour");
      const min = document.getElementById("birthMinute");
      const nowY = new Date().getFullYear();
      for (let i = nowY; i >= 1940; i--) y.add(new Option(i + " å¹´", i));
      for (let i = 1; i <= 12; i++) m.add(new Option(i + " æœˆ", i));
      for (let i = 0; i < 24; i++) h.add(new Option(pad2(i) + " æ™‚", i));
      ["00","15","30","45"].forEach(v => min.add(new Option(v + " åˆ†", v)));
      function updateDays(){
        const year = Number(y.value);
        const month = Number(m.value);
        const cur = d.value;
        d.innerHTML = "";
        const days = new Date(year, month, 0).getDate();
        for (let i = 1; i <= days; i++){
          const opt = new Option(i + " æ—¥", i);
          d.add(opt);
        }
        if (cur && Number(cur) <= days) d.value = cur;
      }
    // 2ï¸âƒ£ äº”è¡Œæ¯”ä¾‹ï¼šè½‰æˆ 0~100%ï¼Œå†ä¸Ÿçµ¦ renderBar
    const ratios = scores?.elementRatios || {};
    console.log("[renderZiweiScores] elementRatios =", ratios);

      y.value = "1990";
      m.value = "1";
      h.value = "12";
      min.value = "00";
      updateDays();
    const wxForBar = {
      æœ¨: (Number(ratios["æœ¨"]) || 0) * 100,
      ç«: (Number(ratios["ç«"]) || 0) * 100,
      åœŸ: (Number(ratios["åœŸ"]) || 0) * 100,
      é‡‘: (Number(ratios["é‡‘"]) || 0) * 100,
      æ°´: (Number(ratios["æ°´"]) || 0) * 100,
    };

      y.addEventListener("change", updateDays);
      m.addEventListener("change", updateDays);
    renderBar("ziweiWx", wxForBar, 100);
  }
  // ====== INIT SELECTORS ======
  function initSelectors(){
    const y   = document.getElementById("birthYear");
    const m   = document.getElementById("birthMonth");
    const d   = document.getElementById("birthDay");
    const h   = document.getElementById("birthHour");
    const min = document.getElementById("birthMinute");
    const nowY = new Date().getFullYear();
    for (let i = nowY; i >= 1940; i--) y.add(new Option(i + " å¹´", i));
    for (let i = 1; i <= 12; i++) m.add(new Option(i + " æœˆ", i));
    for (let i = 0; i < 24; i++) h.add(new Option(pad2(i) + " æ™‚", i));
    ["00","15","30","45"].forEach(v => min.add(new Option(v + " åˆ†", v)));
    function updateDays(){
      const year = Number(y.value);
      const month = Number(m.value);
      const cur = d.value;
      d.innerHTML = "";
      const days = new Date(year, month, 0).getDate();
      for (let i = 1; i <= days; i++){
        const opt = new Option(i + " æ—¥", i);
        d.add(opt);
      }
      if (cur && Number(cur) <= days) d.value = cur;
    }

    document.addEventListener("DOMContentLoaded", async ()=>{
      initSelectors();
      document.getElementById("btnLaunch").addEventListener("click", calculate);
      await loadDbContent();
    y.value = "1990";
    m.value = "1";
    h.value = "12";
    min.value = "00";
    updateDays();

      const closeBtn = document.getElementById("palaceSheetClose");
      const backdrop = document.getElementById("palaceSheetBackdrop");
      if (closeBtn) closeBtn.addEventListener("click", closePalaceSheet);
      if (backdrop) backdrop.addEventListener("click", closePalaceSheet);
    });
    y.addEventListener("change", updateDays);
    m.addEventListener("change", updateDays);
  }

  </script>
  // ====== BOOT ======
  document.addEventListener("DOMContentLoaded", async ()=>{
    initSelectors();
    document.getElementById("btnLaunch").addEventListener("click", calculate);
    await loadDbContent();

  <!-- æ‰‹æ©Ÿç‰ˆå®®ä½è©³è§£ Bottom Sheet -->
  <div id="palaceSheetBackdrop" class="fixed inset-0 bg-black/40 z-40 hidden md:hidden"></div>
    // Mobile Bottom Sheet é—œé–‰äº‹ä»¶
    const closeBtn = document.getElementById("palaceSheetClose");
    const backdrop = document.getElementById("palaceSheetBackdrop");
    if (closeBtn) closeBtn.addEventListener("click", closePalaceSheet);
    if (backdrop) backdrop.addEventListener("click", closePalaceSheet);
  });
</script>
