 <!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç´«å¾®è–äºº0.1ï½œä¸€èµ·å‡ºä¾†ç©</title>

  <!-- Tailwind CDNï¼ˆé–‹ç™¼ç”¨ï¼‰ -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body{
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%, #000 100%);
      color:#e2e8f0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }
    .glass{
      background: rgba(15,23,42,0.88);
      backdrop-filter: blur(18px);
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow: 0 24px 60px rgba(15,23,42,0.85);
      border-radius: 1.25rem;
    }
    .section-subtitle{
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #94a3b8;
    }
    .nav-bar{
      background: linear-gradient(90deg, #ef4444, #f97316, #ef4444);
      color:#fff;
      padding: 10px 16px;
      position: sticky;
      top: 0;
      z-index: 60;
      box-shadow: 0 4px 20px rgba(220,38,38,0.6);
    }
    .nav-chip{
      background: rgba(0,0,0,0.28);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      font-weight: 800;
      letter-spacing: .08em;
      text-transform: uppercase;
      transition: transform .15s ease, background .2s ease;
      user-select: none;
    }
    .nav-chip:hover{ transform: translateY(-1px); background: rgba(0,0,0,0.38); }

    .bazi-char{
      font-size: 1.9rem;
      font-weight: 900;
      line-height: 1.05;
      letter-spacing: .08em;
    }

    /* äº”è¡Œ bar é¡è‰² */
    .wuxing-æœ¨{background:#22c55e}
    .wuxing-ç«{background:#ef4444}
    .wuxing-åœŸ{background:#eab308}
    .wuxing-é‡‘{background:#e5e7eb}
    .wuxing-æ°´{background:#3b82f6}

    /* æ˜Ÿæ›œäº”è¡Œé¡è‰² */
    .star-wx-æœ¨ { color: #86efac; text-shadow: 0 0 5px rgba(34,197,94,0.5); }
    .star-wx-ç« { color: #fca5a5; text-shadow: 0 0 5px rgba(239,68,68,0.5); }
    .star-wx-åœŸ { color: #fde047; text-shadow: 0 0 5px rgba(234,179,8,0.5); }
    .star-wx-é‡‘ { color: #e2e8f0; text-shadow: 0 0 5px rgba(255,255,255,0.5); }
    .star-wx-æ°´ { color: #93c5fd; text-shadow: 0 0 5px rgba(59,130,246,0.5); }

    /* ç´«å¾® 12 å®®æ ¼ */
    .zw-grid-container{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 8px;
      width: 100%;
      max-width: 540px;
      aspect-ratio: 1/1;
      margin: 0 auto;
    }
    .zw-palace{
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 0.85rem;
      padding: 8px;
      display:flex;
      flex-direction: column;
      position: relative;
      overflow:hidden;
      cursor:pointer;
      transition: transform 0.22s ease, border-color 0.22s ease, box-shadow 0.22s ease, background 0.22s ease;
    }
    .zw-palace:hover{
      transform: translateY(-2px);
      border-color: rgba(248,250,252,0.85);
      box-shadow: 0 10px 30px rgba(15,23,42,0.7);
    }

    /* å®®ä½ä¸»é¡Œç™¼å…‰ */
    .zw-palace::before{
      content:'';
      position:absolute;
      top:50%; left:50%;
      width:150%; height:150%;
      transform: translate(-50%, -50%);
      opacity:0;
      transition: opacity 0.5s ease;
      z-index:-1;
      pointer-events:none;
    }
    [class*="palace-glow-"]::before{ opacity:1; }
    .palace-glow-æœ¨::before { background: radial-gradient(circle, rgba(34,197,94,0.18) 0%, transparent 70%); }
    .palace-glow-ç«::before { background: radial-gradient(circle, rgba(239,68,68,0.20) 0%, transparent 70%); }
    .palace-glow-åœŸ::before { background: radial-gradient(circle, rgba(234,179,8,0.20) 0%, transparent 70%); }
    .palace-glow-é‡‘::before { background: radial-gradient(circle, rgba(248,250,252,0.18) 0%, transparent 70%); }
    .palace-glow-æ°´::before { background: radial-gradient(circle, rgba(59,130,246,0.20) 0%, transparent 70%); }

    .zw-palace-key{
      border-color: rgba(251, 191, 36, 0.75);
      box-shadow: inset 0 0 16px rgba(251,191,36,0.22);
    }

    /* ä¸‰æ–¹å››æ­£äº’å‹•é«˜äº® */
    .zw-palace.is-active{
      border-color:#fbbf24 !important;
      box-shadow: 0 0 0 2px rgba(251,191,36,0.25), 0 16px 44px rgba(251,191,36,0.12);
      transform: scale(1.03);
      z-index: 30;
    }
    .zw-palace.is-related{
      border-color: rgba(251,191,36,0.30);
      background: rgba(251,191,36,0.06);
    }

    .zw-center-block{
      grid-area: 2 / 2 / 4 / 4;
      background: radial-gradient(circle, #1e293b 35%, #020617 100%);
      border: 1px dashed rgba(148, 163, 184, 0.5);
      border-radius: 1.1rem;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      padding: 12px;
      z-index: 10;
    }

    /* å°åœ“é» */
    .month-dot{ width:6px; height:6px; border-radius:999px; display:inline-block; margin-right:6px; }
    .bg-red-light{ background:#ef4444; box-shadow:0 0 8px rgba(239,68,68,0.8); }
    .bg-green-light{ background:#10b981; box-shadow:0 0 8px rgba(16,185,129,0.8); }

    /* è®“ anchor ä¸è¢« sticky nav é®åˆ° */
    section{ scroll-margin-top: 84px; }

    @media (max-width: 420px){
      .bazi-char{ font-size: 1.6rem; }
      .zw-palace div{ font-size: 11px; }
    }

    /* ===== æ‰‹æ©Ÿç‰ˆï¼šå®®ä½è©³è§£ Bottom Sheet ===== */
    .palace-sheet {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      max-height: 80vh;
      background: rgba(15,23,42,0.98);
      border-radius: 1.25rem 1.25rem 0 0;
      box-shadow: 0 -20px 40px rgba(0,0,0,0.7);
      transform: translateY(100%);
      opacity: 0;
      pointer-events: none;
      transition: transform 0.25s ease-out, opacity 0.2s ease-out;
      padding: 12px 16px 24px;
      z-index: 50;
    }
    .palace-sheet.open {
      transform: translateY(0);
      opacity: 1;
      pointer-events: auto;
    }
    .palace-sheet-handle {
      width: 40px;
      height: 4px;
      border-radius: 999px;
      background: rgba(148,163,184,0.7);
      margin: 0 auto 8px;
    }
    .palace-sheet-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
    }
    .palace-sheet-close {
      font-size: 11px;
      color: #94a3b8;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.8);
    }

    /* æ‰‹æ©Ÿé™å®šé¡¯ç¤º Bottom Sheetï¼ˆmd ä»¥ä¸Šéš±è—ï¼‰ */
    @media (min-width: 768px){
      .palace-sheet,
      #palaceSheetBackdrop {
        display: none !important;
      }
    }
  </style>
</head>

<body class="pb-20">

  <!-- TOP NAV -->
  <div class="nav-bar flex items-center justify-between gap-3">
    <div class="flex items-center gap-2">
      <div class="font-black tracking-[0.22em] text-[10px] uppercase">ä¸€èµ·å‡ºä¾†ç©</div>
      <div class="text-[10px] opacity-85">ç´«å¾®è–äºº0.1</div>
    </div>

    <!-- workspace nav (only after system entered) -->
    <div id="workspaceNav" class="hidden md:flex items-center gap-2">
      <a class="nav-chip" href="#ws-ziwei">ç´«å¾®</a>
      <a class="nav-chip" href="#ws-bazi">å…«å­—äº”è¡Œ</a>
      <a class="nav-chip" href="#ws-liuyue">æµæœˆç¯€å¥</a>
      <a class="nav-chip" href="#ws-strategy">æˆ°ç•¥é¢æ¿</a>
      <a class="nav-chip" href="#ws-consult">è«®è©¢</a>
    </div>

    <div class="flex items-center gap-2">
      <a id="navCta" href="#ws-consult" class="hidden nav-chip bg-white/15">é ç´„è«®è©¢</a>
      <a href="https://www.youtube.com/@billeetw1" target="_blank" class="nav-chip bg-white text-red-600 border-white/0">è¨‚é–± ğŸ””</a>
    </div>
  </div>

  <main class="max-w-7xl mx-auto px-4 pt-6 space-y-8">

    <!-- LANDING -->
    <header id="landing" class="text-center space-y-3">
      <p class="section-subtitle">2026 Strategic Command Hub</p>
      <h1 class="text-3xl md:text-5xl font-black tracking-tight">
        ç´«å¾®è–äºº0.1
      </h1>
      <p class="text-sm text-slate-400 max-w-3xl mx-auto">
        å¾Œç«¯åŒæ­¥è¨ˆç®—ï¼šå…«å­—äº”è¡Œï¼ˆå«è—å¹²åŠ æ¬Šï¼‰ï¼‹åç¥ä¸»è»¸ï¼‹2026 æµæœˆç´…ç¶ ç‡ˆï¼‹ç´«å¾® 12 å®®ä¸»/å‰¯æ˜Ÿã€‚<br/>
        ä½ åªè¦é»å®®ä½ï¼Œç³»çµ±å°±æœƒé¡¯ç¤ºã€Œä¸‰æ–¹å››æ­£ã€ä¸¦æŠŠè©²å®®ä½æ¶‰åŠçš„æ˜Ÿæ›œèˆ‡è³‡æ–™åº«è§£é‡‹ä¸€èµ·æ”¤é–‹ã€‚
      </p>
    </header>

    <!-- INPUT (will be removed after entering system) -->
    <section id="inputCard" class="glass p-6 md:p-7 max-w-2xl mx-auto space-y-5">
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="section-subtitle mb-1">Step 1</div>
          <h2 class="text-lg font-black">è¼¸å…¥å‡ºç”Ÿè³‡æ–™</h2>
          <p class="text-xs text-slate-400 mt-1">ï¼ˆè¨ˆç®—å¾Œæœƒé€²å…¥ç³»çµ±å·¥ä½œå€ï¼Œé€™å€‹è¼¸å…¥å¡æœƒè‡ªå‹•æ”¶èµ·ï¼‰</p>
        </div>
      </div>

      <div class="grid grid-cols-3 gap-2">
        <select id="birthYear"  class="bg-black/40 p-3 rounded-xl text-sm border border-white/10"></select>
        <select id="birthMonth" class="bg-black/40 p-3 rounded-xl text-sm border border-white/10"></select>
        <select id="birthDay"   class="bg-black/40 p-3 rounded-xl text-sm border border-white/10"></select>
      </div>

      <div class="grid grid-cols-3 gap-2">
        <select id="birthHour"   class="bg-black/40 p-3 rounded-xl text-sm border border-white/10 col-span-2"></select>
        <select id="birthMinute" class="bg-black/40 p-3 rounded-xl text-sm border border-white/10"></select>
      </div>

      <button id="btnLaunch"
        class="w-full bg-amber-500 hover:bg-amber-400 text-black py-4 rounded-2xl font-black text-sm tracking-[0.22em] uppercase transition disabled:opacity-60 disabled:cursor-not-allowed">
        é€²å…¥ 2026 æŒ‡æ®ä¸­å¿ƒ
      </button>

      <div id="hint" class="text-center text-xs text-slate-400 italic min-h-[1.2em]"></div>
    </section>

    <!-- SYSTEM WORKSPACES -->
    <section id="system" class="hidden space-y-8">

      <!-- TOP SUMMARY BAR (after computed) -->
      <section id="ws-summary" class="glass p-6 md:p-7">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <div class="section-subtitle mb-1">Command Summary</div>
            <div class="text-lg md:text-xl font-black">
              <span id="summaryBirth" class="text-slate-200"></span>
            </div>
            <div class="text-xs text-slate-400 mt-1">
              æ—¥ä¸»ï¼š<span class="font-bold text-amber-300" id="summaryDM">â€”</span>
              ï½œåç¥ä¸»è»¸ï¼š<span class="font-bold text-amber-300" id="summaryDominant">â€”</span>
              ï½œå£“åŠ›æœˆï¼š<span class="font-bold text-red-300" id="summaryRedMonths">â€”</span>
            </div>
          </div>

          <div class="flex flex-wrap gap-2">
            <a href="#ws-ziwei" class="nav-chip">å»ç´«å¾®</a>
            <a href="#ws-bazi" class="nav-chip">å»å…«å­—äº”è¡Œ</a>
            <a href="#ws-liuyue" class="nav-chip">å»æµæœˆ</a>
            <a href="#ws-consult" class="nav-chip bg-white/15">è«®è©¢</a>
          </div>
        </div>
      </section>

      <div class="grid xl:grid-cols-[1fr,440px] gap-8">

        <!-- LEFT WORKSPACES -->
        <div class="space-y-8">

          <!-- ç´«å¾® -->
          <section id="ws-ziwei" class="glass p-6 md:p-7 space-y-4">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="section-subtitle mb-1">Zi Wei Dou Shu</div>
                <h2 class="text-xl font-black tracking-tight">ç´«å¾®å‘½ç›¤ Â· 12 å®®ç¸½è¦½</h2>
                <p class="text-xs text-slate-400 mt-1">é»ä»»ä¸€å®®ä½ï¼šå³å´æœƒå‡ºç¾å®®ä½è³‡æ–™åº«è§£é‡‹ï¼‹æ˜Ÿæ›œè§£é‡‹ï¼Œä¸¦è‡ªå‹•æ¨™ç¤ºä¸‰æ–¹å››æ­£ã€‚</p>
              </div>
              <div class="text-[11px] text-slate-400 text-right" id="ziweiMeta">â€”</div>
            </div>

            <div id="ziweiGrid" class="zw-grid-container"></div>

            <div class="text-xs text-slate-400" id="ziweiHint"></div>
          </section>

          <!-- å…«å­—äº”è¡Œ -->
          <section id="ws-bazi" class="glass p-6 md:p-7 space-y-6">
            <div>
              <div class="section-subtitle mb-1">BaZi + Elements</div>
              <h2 class="text-xl font-black tracking-tight">å…«å­— Â· å››æŸ±ï¼‹äº”è¡Œæˆ°åŠ›</h2>
              <p class="text-xs text-slate-400 mt-1">
                ä¸Šæ–¹é¡¯ç¤ºã€Œå››æŸ±ã€ï¼Œä¸‹æ–¹é¡¯ç¤ºã€Œè¡¨å±¤ï¼ˆå¤©å¹²ï¼‰ã€èˆ‡ã€Œå¯¦æˆ°ï¼ˆå¤©å¹²ï¼‹è—å¹²ï¼‹æœˆä»¤åŠ æ¬Šï¼‰ã€ã€‚
                å³å´æœƒé™„ä¸Šäº”è¡Œæ„ç¾©ï¼ˆè³‡æ–™åº«ï¼šwuxing_meaningsï¼‰ã€‚
              </p>
            </div>

            <!-- å››æŸ± -->
            <div class="grid grid-cols-4 gap-2 text-center" id="pillarsGrid"></div>

            <!-- è—å¹² -->
            <div class="space-y-3">
              <div class="text-xs text-slate-400">
                åœ°æ”¯è—å¹²ï¼ˆæ¬Šé‡é¡¯ç¤ºï¼‰ï¼š<span class="text-slate-500">ï¼ˆç”¨ä¾†ç†è§£ä½ ã€Œå¯¦æˆ°äº”è¡Œã€çš„ä¾†æºï¼‰</span>
              </div>
              <div id="cangganGrid" class="grid md:grid-cols-2 gap-2"></div>
            </div>

            <!-- äº”è¡Œ bar -->
            <div class="grid md:grid-cols-2 gap-6">
              <div>
                <div class="text-xs text-slate-400 mb-2">è¡¨å±¤çµæ§‹ï¼ˆå››æŸ±å¤©å¹²ï¼‰</div>
                <div id="surfaceWx" class="space-y-2"></div>
              </div>
              <div>
                <div class="text-xs text-slate-400 mb-2">å¯¦æˆ°çµæ§‹ï¼ˆå¤©å¹²ï¼‹è—å¹²ï¼‹æœˆä»¤åŠ æ¬Šï¼‰</div>
                <div id="strategicWx" class="space-y-2"></div>
              </div>
            </div>

            <!-- åç¥æŒ‡ä»¤ -->
            <div class="border-t border-white/10 pt-5">
              <div class="text-xs text-slate-400 mb-2">åç¥ä¸»è»¸æŒ‡ä»¤ï¼ˆè³‡æ–™åº«ï¼šten_god_analysisï¼‰</div>
              <div id="tenGodCommand" class="p-4 rounded-xl bg-amber-500/10 border border-amber-400/30 text-amber-200 text-sm leading-relaxed">
                â€”
              </div>
            </div>
          </section>

          <!-- æµæœˆ -->
          <section id="ws-liuyue" class="glass p-6 md:p-7 space-y-4">
            <div>
              <div class="section-subtitle mb-1">2026 Monthly Flow</div>
              <h2 class="text-xl font-black tracking-tight">2026 æµæœˆç´…ç¶ ç‡ˆï¼ˆ12ï¼‰</h2>
              <p class="text-xs text-slate-400 mt-1">ğŸ”´ å£“åŠ›æœˆï¼šå…ˆå®ˆè¦å‰‡ï¼ğŸŸ¢ ç©©é€²æœˆï¼šé©åˆæ¨é€²å°ˆæ¡ˆ</p>
            </div>
             <div id="monthGrid" class="space-y-2"></div>
             <div id="monthDetailBox" class="mt-4 space-y-2 text-xs"></div>
          </section>

          <!-- æˆ°ç•¥é¢æ¿ -->
          <section id="ws-strategy" class="glass p-6 md:p-7 space-y-4">
            <div>
              <div class="section-subtitle mb-1">Strategic Panel</div>
              <h2 class="text-xl font-black tracking-tight">2026 æˆ°è¡“å»ºè­°ï¼ˆå‹•æ…‹æ±ºç­–ï¼‰</h2>
              <p class="text-xs text-slate-400 mt-1">
                ä¾ã€Œäº”è¡Œä½”æ¯”ã€ï¼‹ã€Œåç¥ä¸»è»¸ã€çµ¦ä½ ä»Šå¹´çš„æˆ°è¡“æç¤ºï¼ˆå‰ç«¯å³æ™‚è¨ˆç®—ï¼›è§£é‡‹æ–‡å­—å„ªå…ˆåƒè³‡æ–™åº«ï¼‰ã€‚
              </p>
            </div>

            <div id="tacticalBox" class="space-y-2"></div>

            <div class="text-[11px] text-slate-500">
              è¨»ï¼šé€™æ®µæ˜¯ã€ŒæŒ‡æ®ä¸­å¿ƒçš„æˆ°è¡“æç¤ºã€ï¼Œå®®ä½è©³è§£è«‹é»ç´«å¾®æ–¹ç›¤ã€‚
            </div>
          </section>

          <!-- è«®è©¢ CTA -->
          <section id="ws-consult" class="glass p-7 md:p-9 space-y-5 text-center border border-amber-400/40">
            <div>
              <div class="section-subtitle mb-1">1:1 Consulting</div>
              <h2 class="text-2xl md:text-4xl font-black text-amber-300 tracking-tight">æƒ³æŠŠé€™ä»½æˆ°ç•¥è®Šæˆã€Œå¯ä¿ç”¨ä¸€ç”Ÿã€çš„èªªæ˜æ›¸ï¼Ÿ</h2>
            </div>
            <p class="text-slate-300 max-w-2xl mx-auto leading-relaxed text-sm md:text-base">
              å¦‚æœä½ å¸Œæœ›æˆ‘æŠŠä½ çš„å‘½æ ¼çµ„æˆã€äººç”Ÿå¤§é‹ã€æµå¹´æµæœˆã€ç”Ÿæ¶¯è¦åŠƒèˆ‡æœ€é©åˆè‡ªå·±çš„ç¯€å¥ï¼Œ
              åšæˆå¯ä¿ç”¨ä¸€ç”Ÿçš„ 50 é äººç”Ÿä½¿ç”¨èªªæ˜æ›¸ï¼Œæ­¡è¿é ç´„ç·šä¸Šè«®è©¢ã€‚
            </p>
            <a href="https://forms.gle/UVCSq1udEC549gzYA" target="_blank"
              class="inline-flex items-center justify-center px-8 py-4 rounded-2xl bg-gradient-to-r from-amber-400 to-yellow-500 text-slate-950 font-black tracking-widest hover:brightness-110 active:scale-[0.98] transition shadow-xl">
              å‰å¾€é ç´„ç·šä¸Šè«®è©¢
            </a>
          </section>

        </div>

        <!-- RIGHT DETAIL PANELï¼ˆæ¡Œæ©Ÿç”¨ï¼‰ -->
        <aside class="space-y-6" id="detailPanel">
          <div class="glass p-6 md:p-7 sticky top-24 border border-amber-500/30 overflow-y-auto max-h-[85vh]">
            <div class="section-subtitle mb-2">Palace Detail</div>
            <div id="palaceTitle" class="text-3xl font-black text-amber-400">è«‹é»å®®ä½</div>
            <div id="palaceSub" class="text-xs text-slate-400 mt-2 leading-relaxed"></div>

            <div class="mt-6 space-y-6" id="palaceDetailBody">
              <div class="text-center py-10 text-slate-500 italic text-sm">é»æ“Šç´«å¾®æ–¹ç›¤çš„ä»»ä¸€å®®ä½ï¼Œé€™è£¡æœƒé¡¯ç¤ºè©³è§£ã€‚</div>
            </div>

            <div class="mt-8 pt-6 border-t border-white/10">
              <div class="text-[10px] text-slate-500 uppercase font-black mb-3 tracking-widest">2026 æµæœˆç¯€å¥ï¼ˆå¿«é€Ÿåƒè€ƒï¼‰</div>
              <div id="monthlyRhythmBox" class="grid grid-cols-1 gap-2"></div>
            </div>
          </div>

          <div class="glass p-6 border border-white/10">
            <div class="section-subtitle mb-2">Five Elements Meanings</div>
            <div class="font-black text-lg">é‡‘æœ¨æ°´ç«åœŸ Â· åŸºæœ¬æ„ç¾©</div>
            <div class="text-xs text-slate-400 mt-1">ï¼ˆå…§å®¹å„ªå…ˆä¾†è‡ªè³‡æ–™åº«ï¼šwuxing_meaningsï¼›è‹¥ç„¡å‰‡é¡¯ç¤ºé è¨­ï¼‰</div>
            <div id="wuxingMeaningBox" class="mt-4 space-y-3"></div>
          </div>

        </aside>
      </div>
    </section>
  </main>

  <script>
    // ====== CONFIG ======
    const API_BASE = "https://17gonplay-api.billeetw.workers.dev";

    // ====== CONSTANTS ======
// é è¨­é †åºï¼ˆfallback ç”¨ï¼‰ï¼ŒçœŸçš„ç”¨çš„æœƒæ˜¯ RUNTIME_PALACE_RING
const PALACE_DEFAULT = ["å‘½å®®","å…„å¼Ÿ","å¤«å¦»","å­å¥³","è²¡å¸›","ç–¾å„","é·ç§»","åƒ•å½¹","å®˜ç¥¿","ç”°å®…","ç¦å¾·","çˆ¶æ¯"];

// é€™å€‹æ‰æ˜¯å¯¦éš›é‹è¡Œæ™‚ç”¨çš„ã€Œå®®ä½ç’°ã€ï¼Œå…ˆç”¨é è¨­ï¼Œç­‰ API å›ä¾†å†è¦†è“‹
let PALACE_RING = PALACE_DEFAULT.slice();



    // å®®ä½ç°¡ç¹å°ç…§
    const PALACE_KEY_MAP = {
      "å…„å¼Ÿ": ["å…„å¼Ÿ"],
      "å‘½å®®": ["å‘½å®®","å‘½å®«"],
      "å¤«å¦»": ["å¤«å¦»"],
      "å­å¥³": ["å­å¥³"],
      "è²¡å¸›": ["è²¡å¸›","è´¢å¸›"],
      "ç–¾å„": ["ç–¾å„"],
      "é·ç§»": ["é·ç§»","è¿ç§»"],
      "åƒ•å½¹": ["åƒ•å½¹","ä»†å½¹"],
      "å®˜ç¥¿": ["å®˜ç¥¿","å®˜ç¦„"],
      "ç”°å®…": ["ç”°å®…"],
      "ç¦å¾·": ["ç¦å¾·"],
      "çˆ¶æ¯": ["çˆ¶æ¯"],
    };

   // 12 å®®ç›¤é¢ä½ç½®ï¼ˆ4x4 å¤–åœˆï¼‰
// ç´¢å¼•ï¼š0:å¯…(å·¦ä¸‹), 1:å¯, 2:è¾°, 3:å·³(å·¦ä¸Š), 4:åˆ, 5:æœª, 6:ç”³(å³ä¸Š), 7:é…‰, 8:æˆŒ, 9:äº¥(å³ä¸‹), 10:å­, 11:ä¸‘
const gridAreas = [
  "4/1/5/2", // 0: å¯… (å·¦ä¸‹)
  "3/1/4/2", // 1: å¯
  "2/1/3/2", // 2: è¾°
  "1/1/2/2", // 3: å·³ (å·¦ä¸Š)
  "1/2/2/3", // 4: åˆ
  "1/3/2/4", // 5: æœª
  "1/4/2/5", // 6: ç”³ (å³ä¸Š)
  "2/4/3/5", // 7: é…‰
  "3/4/4/5", // 8: æˆŒ
  "4/4/5/5", // 9: äº¥ (å³ä¸‹)
  "4/3/5/4", // 10: å­
  "4/2/5/3"  // 11: ä¸‘
];

 const STAR_NAME_TRAD_MAP = {
  // 14 ä¸»æ˜Ÿ
  "ç´«å¾®": "ç´«å¾®", "ç´«è–‡": "ç´«å¾®",
  "å¤©æœº": "å¤©æ©Ÿ", "å¤©æ©Ÿ": "å¤©æ©Ÿ",
  "å¤ªé˜³": "å¤ªé™½", "å¤ªé™½": "å¤ªé™½",
  "å¤ªé˜´": "å¤ªé™°", "å¤ªé™°": "å¤ªé™°",
  "æ­¦æ›²": "æ­¦æ›²",
  "å¤©åŒ": "å¤©åŒ",
  "å»‰è´": "å»‰è²", "å»‰è²": "å»‰è²",
  "å¤©åºœ": "å¤©åºœ",
  "è´ªç‹¼": "è²ªç‹¼", "è²ªç‹¼": "è²ªç‹¼",
  "å·¨é—¨": "å·¨é–€", "å·¨é–€": "å·¨é–€",
  "å¤©ç›¸": "å¤©ç›¸",
  "å¤©æ¢": "å¤©æ¢",
  "ä¸ƒæ€": "ä¸ƒæ®º", "ä¸ƒæ®º": "ä¸ƒæ®º",
  "ç ´å†›": "ç ´è»", "ç ´è»": "ç ´è»",

  // å…­å‰æ˜Ÿ
  "å·¦è¾…": "å·¦è¼”", "å·¦è¼”": "å·¦è¼”",
  "å³å¼¼": "å³å¼¼",
  "æ–‡æ˜Œ": "æ–‡æ˜Œ",
  "æ–‡æ›²": "æ–‡æ›²",
  "å¤©é­": "å¤©é­",
  "å¤©é’º": "å¤©é‰", "å¤©é‰": "å¤©é‰",

  // å…­ç…æ˜Ÿ
  "æ“ç¾Š": "æ“ç¾Š",
  "é™€ç½—": "é™€ç¾…", "é™€ç¾…": "é™€ç¾…",
  "ç«æ˜Ÿ": "ç«æ˜Ÿ",
  "é“ƒæ˜Ÿ": "éˆ´æ˜Ÿ", "éˆ´æ˜Ÿ": "éˆ´æ˜Ÿ",
  "åœ°åŠ«": "åœ°åŠ«",
  "åœ°ç©º": "åœ°ç©º",

  // é‡è¦è¼”æ˜Ÿ
  "ç¦„å­˜": "ç¥¿å­˜", "ç¥¿å­˜": "ç¥¿å­˜",
  "å¤©é©¬": "å¤©é¦¬", "å¤©é¦¬": "å¤©é¦¬",
  "å¤©ä¼¤": "å¤©å‚·", "å¤©å‚·": "å¤©å‚·",
  "å¤©ä½¿": "å¤©ä½¿",
  "å¤©æ‰": "å¤©æ‰",
  "å¤©å¯¿": "å¤©å£½", "å¤©å£½": "å¤©å£½",
  "å¤©å®˜": "å¤©å®˜",
  "å¤©ç¦": "å¤©ç¦",
  "å¤©å·«": "å¤©å·«",
  "å¤©å–œ": "å¤©å–œ",
  "å¤©å§š": "å¤©å§š",
  "ç´…é¸": "ç´…é¸", "çº¢é¸¾": "ç´…é¸",
  "å¤©åˆ‘": "å¤©åˆ‘",
  "è§£ç¥": "è§£ç¥",

  // --- è£œè¶³é›œæ›œèˆ‡ç¥ç… ---
  "å¤©å¨": "å¤©å»š", "å¤©å»š": "å¤©å»š",
  "æˆªè·¯": "æˆªè·¯",
  "å­¤è¾°": "å­¤è¾°",
  "å¯¡å®¿": "å¯¡å®¿",
  "ç©ºäº¡": "ç©ºäº¡",
  "ç ´ç¢": "ç ´ç¢",
  "å¤©è´µ": "å¤©è²´", "å¤©è²´": "å¤©è²´",
  "åç›–": "è¯è“‹", "è¯è“‹": "è¯è“‹",
  "å¤©å“­": "å¤©å“­",
  "å¤©è™š": "å¤©è™›", "å¤©è™›": "å¤©è™›",
  "å¤©å¾·": "å¤©å¾·",
  "æœˆå¾·": "æœˆå¾·",
  "æ—¬ç©º": "æ—¬ç©º",
  "å°è¾…": "å°è¼”", "å°è¼”": "å°è¼”",
  "å°è¯°": "å°èª¥", "å°èª¥": "å°èª¥",
  "é¾™æ± ": "é¾æ± ", "é¾æ± ": "é¾æ± ",
  "å‡¤é˜": "é³³é–£", "é³³é–£": "é³³é–£",
  "å¹´è§£": "å¹´è§£",
  "å’¸æ± ": "å’¸æ± ",
  "ä¸‰å°": "ä¸‰å°",
  "å…«åº§": "å…«åº§",
  "æ©å…‰": "æ©å…‰",
  "èœšå»‰": "èœšå»‰",
  "é˜´ç…": "é™°ç…", "é™°ç…": "é™°ç…",
  "å¤©æœˆ": "å¤©æœˆ",

  // åšå£«åäºŒç¥
  "åšå£«": "åšå£«",
  "åŠ›å£«": "åŠ›å£«",
  "é’é¾": "é’é¾", "é’é¾™": "é’é¾",
  "å°è€—": "å°è€—",
  "å°‡è»": "å°‡è»", "å°†å†›": "å°‡è»",
  "å¥æ›¸": "å¥æ›¸", "å¥ä¹¦": "å¥æ›¸",
  "å–œç¥": "å–œç¥",
  "ç—…ç¬¦": "ç—…ç¬¦",
  "å¤§è€—": "å¤§è€—",
  "ä¼å…µ": "ä¼å…µ",
  "å®˜åºœ": "å®˜åºœ",

  // é¡åˆ¥å‹æ˜Ÿæ›œ
  "ç”²ç´šä¸»æ˜Ÿ": "ç”²ç´šä¸»æ˜Ÿ",
  "å…­å‰æ˜Ÿ": "å…­å‰æ˜Ÿ",
  "å…­ç…æ˜Ÿ": "å…­ç…æ˜Ÿ",
  "å—æ–—ã€åŒ—æ–—æ˜Ÿ": "å—æ–—ã€åŒ—æ–—æ˜Ÿ",
  "ä¸­å¤©æ˜Ÿ": "ä¸­å¤©æ˜Ÿ",
  "è¼”åŠ©æ˜Ÿ": "è¼”åŠ©æ˜Ÿ",
  "ç¥¿å­˜èˆ‡å¤©é¦¬": "ç¥¿å­˜èˆ‡å¤©é¦¬"
};

    function toTraditionalStarName(name){
      return STAR_NAME_TRAD_MAP[name] || name;
    }


    // äº”è¡Œ map ç”¨ã€Œç¹é«”æ˜Ÿåã€
    const STAR_WUXING_MAP = {
      "ç´«å¾®":"åœŸ","å¤©æ©Ÿ":"æœ¨","å¤ªé™½":"ç«","æ­¦æ›²":"é‡‘","å¤©åŒ":"æ°´",
      "å»‰è²":"ç«","å¤©åºœ":"åœŸ","å¤ªé™°":"æ°´","è²ªç‹¼":"æœ¨","å·¨é–€":"æ°´",
      "å¤©ç›¸":"æ°´","å¤©æ¢":"åœŸ","ä¸ƒæ®º":"é‡‘","ç ´è»":"æ°´",
    };

    // åœ°æ”¯è—å¹²ï¼ˆå‰ç«¯é¡¯ç¤ºç”¨ï¼‰
    const CANGGAN_DATA = {
      "å­": { "ç™¸": 1.0 },
      "ä¸‘": { "å·±": 0.6, "ç™¸": 0.3, "è¾›": 0.1 },
      "å¯…": { "ç”²": 0.6, "ä¸™": 0.3, "æˆŠ": 0.1 },
      "å¯": { "ä¹™": 1.0 },
      "è¾°": { "æˆŠ": 0.6, "ä¹™": 0.3, "ç™¸": 0.1 },
      "å·³": { "ä¸™": 0.6, "åºš": 0.3, "æˆŠ": 0.1 },
      "åˆ": { "ä¸": 0.7, "å·±": 0.3 },
      "æœª": { "å·±": 0.6, "ä¸": 0.3, "ä¹™": 0.1 },
      "ç”³": { "åºš": 0.6, "å£¬": 0.3, "æˆŠ": 0.1 },
      "é…‰": { "è¾›": 1.0 },
      "æˆŒ": { "æˆŠ": 0.6, "è¾›": 0.3, "ä¸": 0.1 },
      "äº¥": { "å£¬": 0.7, "ç”²": 0.3 },
    };

    const DEFAULT_WUXING_MEANINGS = {
      "æœ¨": { headline: "æˆé•·èˆ‡è¦åŠƒ", content: "æœ¨ä»£è¡¨ç”Ÿé•·ã€å»¶å±•ã€è¦åŠƒã€å­¸ç¿’èˆ‡äººéš›é€£çµã€‚æœ¨æ—ºå¤šä¸»ä¸»å‹•ã€é¡˜æ„æ¨é€²ï¼›æœ¨å¼±å¸¸éœ€è£œç­–ç•¥èˆ‡é•·æœŸå¸ƒå±€ã€‚" },
      "ç«": { headline: "èƒ½è¦‹åº¦èˆ‡å‹•èƒ½", content: "ç«ä»£è¡¨è¡¨é”ã€æ›å…‰ã€ç†±æƒ…ã€æ¨å‹•èˆ‡æ±ºç­–é€Ÿåº¦ã€‚ç«æ—ºæ˜“è¡éé ­ã€æƒ…ç·’æ±ºç­–ï¼›ç«å¼±å‰‡è¡Œå‹•èˆ‡è‡ªä¿¡ä¸è¶³ã€‚" },
      "åœŸ": { headline: "æ‰¿æ¥èˆ‡ç³»çµ±", content: "åœŸä»£è¡¨ç©©å®šã€å®¹å™¨ã€æµç¨‹ã€è¦ç¯„èˆ‡æŒä¹…åŠ›ã€‚åœŸæ—ºæ˜“æ²‰é‡ä¿å®ˆï¼›åœŸå¼±å‰‡é›£è½åœ°ã€ç¼ºä¹æ‰¿è¼‰ã€‚" },
      "é‡‘": { headline: "çµæ§‹èˆ‡ç•Œç·š", content: "é‡‘ä»£è¡¨è¦å‰‡ã€åˆ‡å‰²ã€æ•ˆç‡ã€æ¨™æº–èˆ‡é¢¨éšªæ§åˆ¶ã€‚é‡‘æ—ºå®¹æ˜“è‹›åˆ»ã€å£“è¿«ï¼›é‡‘å¼±å‰‡ç•Œç·šé¬†æ•£ã€åŸ·è¡Œæ¨™æº–ä¸ç©©ã€‚" },
      "æ°´": { headline: "æµå‹•èˆ‡æ´å¯Ÿ", content: "æ°´ä»£è¡¨è³‡è¨Šã€è³‡æºæµå‹•ã€æ´å¯Ÿèˆ‡é©æ‡‰ã€‚æ°´æ—ºå¸¸å¤šæƒ³å¤šè®Šï¼›æ°´å¼±å‰‡è¦–é‡è®Šçª„ã€è³‡æºèª¿åº¦ä¸é †ã€‚" },
    };

    // ====== STATE ======
    let dbContent = { palaces:{}, stars:{}, tenGods:{}, wuxing:{} };
    let contract = null;
    let selectedPalace = "å‘½å®®";

    // ====== HELPERS ======
    function pad2(n){ return String(n).padStart(2,"0"); }

    function getStarsForPalace(ziwei, palaceName){
      if (!ziwei || !ziwei.mainStars) return [];
      const keys = PALACE_KEY_MAP[palaceName] || [palaceName];
      const all = [];
      keys.forEach(k=>{
        const list = ziwei.mainStars[k];
        if (Array.isArray(list)) list.forEach(s => all.push(s));
      });
      return all;
    }

    function renderBar(targetId, data, max){
      const box = document.getElementById(targetId);
      if (!box) return;
      box.innerHTML = "";
      ["æœ¨","ç«","åœŸ","é‡‘","æ°´"].forEach(e=>{
        const v = Number(data?.[e] || 0);
        const w = max ? Math.max(3, (v / max) * 100) : 0;
        box.innerHTML += `
          <div class="mb-1">
            <div class="flex justify-between text-xs text-slate-300">
              <span class="font-bold">${e}</span>
              <span class="font-mono">${v.toFixed(1)}</span>
            </div>
            <div class="h-2 bg-white/10 rounded overflow-hidden">
              <div class="h-full wuxing-${e}" style="width:${w}%"></div>
            </div>
          </div>
        `;
      });
    }

    function pctFromWx(wx){
      const total = Object.values(wx||{}).reduce((s,v)=>s+(Number(v)||0),0) || 1;
      const pct = {};
      ["æœ¨","ç«","åœŸ","é‡‘","æ°´"].forEach(k => pct[k] = (Number(wx?.[k]||0)/total));
      return { total, pct };
    }

    function computeDynamicTactics(bazi){
      const out = [];
      const dominant = (bazi?.tenGod?.dominant || "").trim();
      const wx = bazi?.wuxing?.strategic || null;
      if (!wx) return out;

      const { pct } = pctFromWx(wx);

      if (pct["ç«"] >= 0.35) out.push({ tone:"red", text:"ğŸ”¥ ç«ä½”æ¯”åé«˜ï¼šä»Šå¹´åšé‡å¤§æ±ºç­–å»ºè­°ã€Œå†·å» 48 å°æ™‚ã€ï¼Œå…ˆå¯«ä¸‹é¢¨éšªæ¸…å–®å†æ‹æ¿ã€‚" });
      if (pct["æ°´"] <= 0.10) out.push({ tone:"blue", text:"ğŸ’§ æ°´ä½”æ¯”åä½ï¼šéœ€è¦åˆ»æ„è£œå……è³‡è¨Šèˆ‡è³‡æºæµå‹•ï¼ˆè·¨ç•Œäº¤æµã€å»ºç«‹è³‡æ–™åº«ã€åšç¾é‡‘æµç·©è¡ï¼‰ã€‚" });
      if (pct["é‡‘"] >= 0.35) out.push({ tone:"slate", text:"âš”ï¸ é‡‘ä½”æ¯”åé«˜ï¼šåŸ·è¡Œæ¨™æº–å¼·ï¼Œä½†æ˜“è®“åˆä½œå£“åŠ›ä¸Šå‡ã€‚å»ºè­°ç”¨æµç¨‹å–ä»£æƒ…ç·’ï¼Œå…ˆå°é½Šè¦æ ¼å†è¦æ±‚é€Ÿåº¦ã€‚" });
      if (pct["åœŸ"] >= 0.40) out.push({ tone:"amber", text:"â›°ï¸ åœŸä½”æ¯”åé«˜ï¼šæ‰¿è¼‰åŠ›å¼·ä½†ç¯€å¥æ˜“éˆã€‚å»ºè­°æŠŠå¤§ç›®æ¨™æ‹†æˆé€±ç¯€é»ï¼Œç”¨å„€è¡¨æ¿æ¨é€²è€Œä¸æ˜¯é æ„å¿—åŠ›ã€‚" });
      if (pct["æœ¨"] >= 0.35) out.push({ tone:"green", text:"ğŸŒ² æœ¨ä½”æ¯”åé«˜ï¼šæ“´å¼µèˆ‡è¦åŠƒå¾ˆå¼·ï¼Œä½†æ³¨æ„æˆ°ç·šéå¤šã€‚å»ºè­°åšã€å‰ªæã€ï¼šç æ‰ 20% ä¸å¿…è¦ä»»å‹™ï¼Œæˆæœæœƒæ›´å¤§ã€‚" });

      if (dominant && dbContent.tenGods?.[dominant]){
        out.push({ tone:"amber", text:`ğŸ§­ åç¥ä¸»è»¸ï¼ˆ${dominant}ï¼‰ï¼š${dbContent.tenGods[dominant]}` });
      } else if (dominant) {
        out.push({ tone:"amber", text:`ğŸ§­ åç¥ä¸»è»¸ï¼ˆ${dominant}ï¼‰ï¼šä»Šå¹´ç”¨ã€Œæµç¨‹åŒ–ã€è¦å‰‡åŒ–ã€æ–¹å¼æ¨é€²ï¼Œå£“åŠ›æœˆå…ˆå®ˆè¦å‰‡å†è«‡çªç ´ã€‚` });
      }

      return out;
    }

    function toneClass(tone){
      if (tone === "red") return "border-red-400/60 bg-red-500/10 text-red-100";
      if (tone === "blue") return "border-blue-400/60 bg-blue-500/10 text-blue-100";
      if (tone === "green") return "border-emerald-400/60 bg-emerald-500/10 text-emerald-100";
      if (tone === "slate") return "border-slate-400/40 bg-white/5 text-slate-100";
      return "border-amber-400/60 bg-amber-500/10 text-amber-100";
    }

    function renderWuxingMeaningBox(){
      const box = document.getElementById("wuxingMeaningBox");
      if (!box) return;
      box.innerHTML = "";
      const src = (dbContent.wuxing && Object.keys(dbContent.wuxing).length) ? dbContent.wuxing : DEFAULT_WUXING_MEANINGS;

      ["æœ¨","ç«","åœŸ","é‡‘","æ°´"].forEach(el=>{
        const item = src[el] || DEFAULT_WUXING_MEANINGS[el];
        box.innerHTML += `
          <div class="p-3 rounded-xl border border-white/10 bg-white/5">
            <div class="flex items-center justify-between">
              <div class="font-black text-slate-100">${el}</div>
              <div class="text-[10px] text-slate-400">${item?.headline || ""}</div>
            </div>
            <div class="text-xs text-slate-300 mt-2 leading-relaxed">${item?.content || ""}</div>
          </div>
        `;
      });
    }

    // ====== RENDER: BAZI ======
    function renderPillars(bazi){
      const grid = document.getElementById("pillarsGrid");
      if (!grid) return;
      grid.innerHTML = "";

      const disp = bazi?.display || {};
      const cols = [
        { label:"å¹´", g:disp.yG, z:disp.yZ, dim:false },
        { label:"æœˆ", g:disp.mG, z:disp.mZ, dim:false },
        { label:"æ—¥", g:disp.dG, z:disp.dZ, dim:true  },
        { label:"æ™‚", g:disp.hG, z:disp.hZ, dim:false },
      ];

      cols.forEach(c=>{
        grid.innerHTML += `
          <div class="p-3 rounded-xl border border-white/10 bg-white/5">
            <div class="text-[10px] text-slate-500 font-black tracking-widest">${c.label}</div>
            <div class="bazi-char ${c.dim ? "text-amber-400" : ""}">${c.g || "â€”"}</div>
            <div class="text-sm text-slate-300">${c.z || "â€”"}</div>
          </div>
        `;
      });

      const cgBox = document.getElementById("cangganGrid");
      if (!cgBox) return;
      cgBox.innerHTML = "";

      const branches = [
        { label:"å¹´æ”¯", z:disp.yZ },
        { label:"æœˆæ”¯", z:disp.mZ },
        { label:"æ—¥æ”¯", z:disp.dZ },
        { label:"æ™‚æ”¯", z:disp.hZ },
      ];

      branches.forEach(b=>{
        const cg = CANGGAN_DATA[b.z] || null;
        const rows = cg ? Object.entries(cg)
          .sort((a,b)=> (b[1]||0)-(a[1]||0))
          .map(([stem,w])=>{
            const pct = Math.round((Number(w)||0)*100);
            return `<span class="inline-flex items-center gap-2 px-2 py-1 rounded-lg bg-black/30 border border-white/10 text-xs">
              <span class="font-black">${stem}</span><span class="text-slate-400">${pct}%</span>
            </span>`;
          }).join(" ")
          : `<span class="text-slate-500 italic text-xs">ï¼ˆç„¡è—å¹²è³‡æ–™ï¼‰</span>`;

        cgBox.innerHTML += `
          <div class="p-3 rounded-xl border border-white/10 bg-white/5">
            <div class="text-xs text-slate-400 mb-2">${b.label}ï¼š<span class="font-black text-slate-200">${b.z || "â€”"}</span></div>
            <div class="flex flex-wrap gap-2">${rows}</div>
          </div>
        `;
      });
    }

    // ====== RENDER: LIUYUE ======
function renderLiuyue(bazi){
  const mGrid   = document.getElementById("monthGrid");
  const detail  = document.getElementById("monthDetailBox");
  const rhythm  = document.getElementById("monthlyRhythmBox");
  if (!mGrid || !rhythm) return;

  const bounds = bazi?.liuyue2026?.bounds || [];
  mGrid.innerHTML = "";
  rhythm.innerHTML = "";
  if (detail) detail.innerHTML = `
    <div class="text-slate-400/80">
      é»ä»»ä¸€å€‹æœˆä»½ï¼Œé€™è£¡æœƒé¡¯ç¤ºï¼šå°ä½ å€‹äººè€Œè¨€çš„
      <span class="text-amber-300 font-bold">å±éšªæŒ‡æ•¸ï¼‹è§¸ç™¼åŸå› ï¼‹æˆ°è¡“æŒ‡ä»¤</span>ã€‚
    </div>
  `;

  if (!bounds.length){
    mGrid.innerHTML = `<div class="text-xs text-slate-400 italic">ï¼ˆæš«ç„¡æµæœˆè³‡æ–™ï¼‰</div>`;
    if (detail){
      detail.innerHTML = `<div class="text-xs text-slate-400 italic">ï¼ˆæš«ç„¡æµæœˆè³‡æ–™ï¼‰</div>`;
    }
    return;
  }

  bounds.forEach((b)=>{
    const isRed = b.light === "RED";
    const tag   = isRed ? "ğŸ”´ å£“åŠ›" : "ğŸŸ¢ ç©©é€²";

    // ä¸»åˆ—è¡¨å¡ç‰‡
    const card = document.createElement("button");
    card.type = "button";
    card.className =
      "w-full text-left flex flex-col gap-1 p-3 rounded-xl border-l-4 transition " +
      (isRed ? "border-red-500 bg-red-500/10 hover:bg-red-500/20"
             : "border-emerald-400 bg-emerald-500/10 hover:bg-emerald-500/20");

    card.innerHTML = `
      <div class="flex items-center justify-between">
        <div>
          <div class="font-black text-sm text-slate-50">
            ${b.gz}
            <span class="text-[10px] text-slate-300 ml-2 font-mono">${b.range || ""}</span>
          </div>
          <div class="text-[11px] text-slate-200 mt-1">
            åç¥ï¼šå¹² ${b.ssStem || "â€”"} ï¼ æ”¯ ${b.ssBranch || "â€”"}
          </div>
        </div>
        <div class="text-right">
          <div class="text-[11px] font-black px-3 py-1 rounded-full bg-black/40">
            ${tag}
          </div>
          <div class="text-[10px] text-slate-400 mt-1">
            å±éšªæŒ‡æ•¸ï¼š
            <span class="${isRed ? "text-red-300" : "text-emerald-300"} font-mono">
              ${b.riskScore ?? "â€”"}
            </span> / 100
          </div>
        </div>
      </div>
    `;

    // é»æŸæœˆ â†’ åœ¨ä¸‹é¢ monthDetailBox é¡¯ç¤ºå€‹æ€§åŒ–åŸå› ï¼‹æˆ°è¡“
    card.addEventListener("click", () => {
      if (!detail) return;
      const reasons = (b.reasonTags || []).join("ï¼");

      detail.innerHTML = `
        <div class="p-4 rounded-xl border ${isRed ? "border-red-400/60 bg-red-500/10" : "border-emerald-400/60 bg-emerald-500/10"} text-sm leading-relaxed space-y-2">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-[11px] uppercase tracking-[0.18em] text-slate-300">Personalized Month Radar</div>
              <div class="font-black text-base text-slate-50 mt-1">
                ${b.gz}ï¼ˆ${b.range}ï¼‰
              </div>
            </div>
            <div class="text-right text-[11px] text-slate-200">
              å±éšªæŒ‡æ•¸
              <div class="text-lg font-mono ${isRed ? "text-red-300" : "text-emerald-300"}">
                ${b.riskScore ?? "â€”"}/100
              </div>
            </div>
          </div>

          <div class="text-[11px] text-slate-200">
            å€‹æ€§åŒ–è§¸ç™¼ï¼š
            <span class="text-slate-100">${reasons || "ï¼ˆå°šæœªæ¨™è¨»è§¸ç™¼åŸå› ï¼‰"}</span>
          </div>

          <div class="text-[11px] text-amber-100 mt-1">
            æˆ°è¡“æŒ‡ä»¤ï¼š
            <span class="text-amber-50">${b.strategy || "ï¼ˆå°šæœªæ’°å¯«æˆ°è¡“å»ºè­°ï¼‰"}</span>
          </div>
        </div>
      `;

      detail.scrollIntoView({ behavior:"smooth", block:"nearest" });
    });

    mGrid.appendChild(card);

    // å³å´ã€Œ2026 æµæœˆç¯€å¥ï¼ˆå¿«é€Ÿåƒè€ƒï¼‰ã€ï¼šåŒæ™‚é¡¯ç¤º riskScore
    rhythm.innerHTML += `
      <div class="flex items-center justify-between p-3 rounded-xl bg-white/5 border border-white/10">
        <div class="flex items-center">
          <span class="month-dot ${isRed ? "bg-red-light" : "bg-green-light"}"></span>
          <span class="text-[11px] font-black text-slate-200">${b.gz}</span>
          <span class="text-[9px] text-slate-500 ml-2 font-mono">${b.range || ""}</span>
        </div>
        <div class="text-right">
          <div class="text-[10px] font-black ${isRed ? "text-red-300" : "text-emerald-300"}">
            ${isRed ? "å®ˆè¦å‰‡" : "æ¨é€²"}
          </div>
          <div class="text-[9px] text-slate-400">å±éšª ${b.riskScore ?? "â€”"}</div>
        </div>
      </div>
    `;
  });
}


    // ====== Mobile Bottom Sheet æ§åˆ¶ ======
    function openPalaceSheet(){
      const sheet = document.getElementById("palaceSheet");
      const backdrop = document.getElementById("palaceSheetBackdrop");
      if (!sheet) return;
      sheet.classList.add("open");
      if (backdrop) backdrop.classList.remove("hidden");
      document.body.style.overflow = "hidden";
    }

    function closePalaceSheet(){
      const sheet = document.getElementById("palaceSheet");
      const backdrop = document.getElementById("palaceSheetBackdrop");
      if (!sheet) return;
      sheet.classList.remove("open");
      if (backdrop) backdrop.classList.add("hidden");
      document.body.style.overflow = "";
    }

    // ====== RENDER: ZIWEI GRID ======
    function renderZiwei(ziwei){
  const container = document.getElementById("ziweiGrid");
  const meta = document.getElementById("ziweiMeta");
  const hint = document.getElementById("ziweiHint");
  if (!container) return;

  container.innerHTML = "";
  if (!ziwei){
    container.innerHTML = `
      <div class="col-span-4 flex items-center justify-center text-xs text-slate-500 text-center">
        ç´«å¾®è³‡æ–™æš«ä¸å¯ç”¨ï¼ˆå¾Œç«¯ iztro å‡ºéŒ¯æˆ–æœªå›å‚³ï¼‰ã€‚è«‹ç¨å¾Œé‡è©¦ã€‚
      </div>`;
    if (meta) meta.textContent = "";
    if (hint) hint.textContent = "";
    return;
  }

  // ğŸ”´ é€™è£¡ç”¨ PALACE_RINGï¼Œä¸è¦å†ç”¨ PALACE_ORDER
  PALACE_RING.forEach((name, idx)=>{
    const rawStars = getStarsForPalace(ziwei, name);
    const stars = rawStars.map(toTraditionalStarName);
    const isKey = ["å‘½å®®","å®˜ç¥¿","è²¡å¸›"].includes(name);

    let palaceMainElement = "";
    if (stars.length){
      palaceMainElement = STAR_WUXING_MAP[stars[0]] || "";
    }
    const glowClass = palaceMainElement ? `palace-glow-${palaceMainElement}` : "";

    const starsHtml = stars.length
      ? stars.map(s=>{
          const wx = STAR_WUXING_MAP[s] || "";
          return `<span class="${wx ? "star-wx-"+wx : ""}">${s}</span>`;
        }).join("<br>")
      : `<span class="text-slate-600 text-xs italic font-normal">ç©ºå®®</span>`;

    const el = document.createElement("div");
    el.className = `zw-palace ${isKey ? "zw-palace-key" : ""} ${glowClass}`;
    el.style.gridArea = gridAreas[idx];
    el.innerHTML = `
      <div class="text-[10px] font-black text-slate-500 mb-1">${name}</div>
      <div class="text-[13px] font-black leading-snug tracking-wide">${starsHtml}</div>
    `;
    el.addEventListener("click", ()=>{
      selectPalace(name);

      if (window.innerWidth <= 768){
        openPalaceSheet();
      } else {
        document.getElementById("detailPanel").scrollIntoView({ behavior:"smooth", block:"start" });
      }
    });

    container.appendChild(el);
  });

  const center = document.createElement("div");
  center.className = "zw-center-block";
  center.innerHTML = `
    <div class="text-[10px] tracking-[0.18em] text-slate-500 font-black">DESTINY CORE</div>
    <div class="text-amber-400 font-black text-xl tracking-widest mt-1">${ziwei.core?.minggong || "â€”"}</div>
    <div class="text-[11px] text-slate-300 mt-1">èº«å®®ï¼š${ziwei.core?.shengong || "â€”"}</div>
    <div class="text-[11px] text-slate-400 mt-1">äº”è¡Œå±€ï¼š${ziwei.core?.wuxingju || "â€”"}</div>
  `;
  container.appendChild(center);

  if (meta) meta.textContent = `å‘½å®®ï¼š${ziwei.core?.minggong || "â€”"}ï½œäº”è¡Œå±€ï¼š${ziwei.core?.wuxingju || "â€”"}`;
  if (hint) hint.innerHTML = `æç¤ºï¼šä¸‰æ–¹å››æ­£ï¼æœ¬å®®ï¼‹å°å®®ï¼‹ä¸‰åˆå…©å®®ï¼ˆé»å®®ä½è‡ªå‹•æ¨™ç¤ºï¼‰ã€‚`;
}
    // ====== Palace Detail (DB-driven) ======
   function selectPalace(name){
  selectedPalace = name;

  // ä¸‰æ–¹å››æ­£ï¼šæœ¬å®® + å°å®®( +6 ) + ä¸‰åˆ( +4, +8 )
  const idx = PALACE_RING.indexOf(name);   // ğŸ”´ é€™è£¡æ”¹æˆ PALACE_RING
  const related = new Set([idx, (idx+6)%12, (idx+4)%12, (idx+8)%12]);

  document.querySelectorAll(".zw-palace").forEach((el, i)=>{
    el.classList.remove("is-active","is-related");
    if (i === idx) el.classList.add("is-active");
    else if (related.has(i)) el.classList.add("is-related");
  });


      const ziwei = contract?.ziwei;
      const rawStars = ziwei ? getStarsForPalace(ziwei, name) : [];
      const stars = rawStars.map(toTraditionalStarName);

      const titleText = `2026 ${name} Â· ä½œæˆ°é¢æ¿`;
      const subText   = `ä¸‰æ–¹å››æ­£å·²æ¨™ç¤ºï¼šæœ¬å®®ï¼‹å°å®®ï¼‹ä¸‰åˆï¼ˆå…±å››å®®ï¼‰ã€‚`;

      // desktop header
      document.getElementById("palaceTitle").textContent = titleText;
      document.getElementById("palaceSub").textContent   = subText;

      const palaceText = (dbContent.palaces && dbContent.palaces[name]) ? dbContent.palaces[name] : "ï¼ˆè³‡æ–™åº«å°šæœªå¡«å…¥æ­¤å®®ä½è§£é‡‹ï¼‰";

      let starCards = "";
      if (stars.length){
        starCards = stars.map(s=>{
          const wx = STAR_WUXING_MAP[s] || "";
          const explain = (dbContent.stars && dbContent.stars[s]) ? dbContent.stars[s] : "ï¼ˆè³‡æ–™åº«å°šæœªå¡«å…¥æ­¤æ˜Ÿæ›œè§£é‡‹ï¼‰";
          return `
            <div class="p-4 rounded-xl border border-white/10 bg-white/5">
              <div class="flex items-center justify-between gap-3">
                <div class="font-black text-base ${wx ? "star-wx-"+wx : "text-slate-200"}">ã€${s}ã€‘</div>
                <div class="text-[10px] text-slate-500">${wx ? "äº”è¡Œï¼š"+wx : ""}</div>
              </div>
              <div class="text-xs text-slate-300 mt-2 leading-relaxed">${explain}</div>
            </div>
          `;



        }).join("");
      } else {
        starCards = `
          <div class="p-4 rounded-xl border border-white/10 bg-white/5">
            <div class="text-sm text-slate-300 font-black">ç©ºå®®</div>
            <div class="text-xs text-slate-400 mt-2">ç©ºå®®ä¸ç­‰æ–¼æ²’æœ‰äº‹ä»¶ï¼Œé‡é»æ˜¯çœ‹ä¸‰æ–¹å››æ­£èˆ‡æµæœˆç¯€å¥å¦‚ä½•å¼•å‹•ã€‚</div>
          </div>
        `;
      }

      const detailHtml = `
        <div class="p-4 rounded-xl border border-amber-400/25 bg-amber-500/10">
          <div class="text-[10px] text-amber-200 font-black tracking-widest uppercase mb-2">è³‡æ–™åº«å®®ä½è§£é‡‹</div>
          <div class="text-sm text-slate-100 leading-relaxed">${palaceText}</div>
        </div>

        <div>
          <div class="text-[10px] text-slate-500 font-black tracking-widest uppercase mb-3">æ˜Ÿæ›œè§£é‡‹ï¼ˆè³‡æ–™åº«ï¼‰</div>
          <div class="space-y-3">${starCards}</div>
        </div>
      `;

      // desktop body
      const body = document.getElementById("palaceDetailBody");
      body.innerHTML = detailHtml;

      // mobile bottom sheet åŒæ­¥
      const mTitle = document.getElementById("mobilePalaceTitle");
      const mSub   = document.getElementById("mobilePalaceSub");
      const mBody  = document.getElementById("mobilePalaceBody");
      if (mTitle) mTitle.textContent = titleText;
      if (mSub)   mSub.textContent   = subText;
      if (mBody)  mBody.innerHTML    = detailHtml;
    }

    // ====== Load DB Content ======
    async function loadDbContent(){
      try{
        const r = await fetch(`${API_BASE}/content/2026`, { method:"GET" });
        const j = await r.json();
        if (j?.ok){
          dbContent = j;
        }
      }catch(e){
        console.warn("loadDbContent failed", e);
      }finally{
        renderWuxingMeaningBox();
      }
    }

    // ====== Calculate ======
    async function calculate(){
      const btn  = document.getElementById("btnLaunch");
      const hint = document.getElementById("hint");
      const original = btn.textContent;

      const vy = Number(document.getElementById("birthYear").value);
      const vm = Number(document.getElementById("birthMonth").value);
      const vd = Number(document.getElementById("birthDay").value);
      const vh = Number(document.getElementById("birthHour").value);
      const vmin = Number(document.getElementById("birthMinute").value);

      try{
        if (![vy,vm,vd,vh,vmin].every(n=>Number.isFinite(n))) throw new Error("è«‹å…ˆé¸å®Œæ•´å‡ºç”Ÿè³‡æ–™");

        btn.disabled = true;
        btn.textContent = "è¨ˆç®—ä¸­â€¦";
        hint.textContent = "æ­£åœ¨é€£ç·šå¾Œç«¯è¨ˆç®—ï¼ˆå…«å­—ï¼‹ç´«å¾®ï¼‹æµæœˆï¼‹åç¥ï¼‰â€¦";
const resp = await fetch(`${API_BASE}/compute/all`, {
  method:"POST",
  headers: {"Content-Type":"application/json"},
  body: JSON.stringify({ year:vy, month:vm, day:vd, hour:vh, minute:vmin })
});

if (!resp.ok){
  const t = await resp.text().catch(()=> "");
  throw new Error(`API HTTP ${resp.status} ${t}`.trim());
}

// âœ… é€™è£¡ä¸€å®šè¦æ˜¯ payloadï¼Œä¸æ˜¯ data
const payload = await resp.json();

// â­ ç¬¬ä¸€æ­¥ï¼šç¢ºèªå¾Œç«¯åˆ°åº•å›äº†ä»€éº¼
console.log("compute/all returns payload:", payload);
console.log("chartId from payload:", payload.chartId);




        if (!payload?.ok) throw new Error(payload?.error || "API error");

        contract = payload.features;
        if (!contract || contract.version !== "strategic_features_v1"){
          throw new Error("features æ ¼å¼éŒ¯èª¤ï¼ˆä¸æ˜¯ strategic_features_v1ï¼‰");
        }

        const bazi = contract.bazi;
        const ziwei = contract.ziwei;
// å‹•æ…‹å®®ä½ç’°ï¼šå¾å¾Œç«¯æ‹¿ iztro çš„ palaces æ’åº
if (ziwei && Array.isArray(ziwei.palaceRing)) {
  PALACE_RING = ziwei.palaceRing.map((name) => {
    // æŠŠã€Œå‘½å®«ã€é€™é¡ç°¡é«”å®®åè½‰æˆä½ å‰ç«¯çµ±ä¸€ç”¨çš„ç¹é«”
    // é€™è£¡ç°¡å–®ç²—æš´è™•ç†ä¸€ä¸‹
    if (name === "å‘½å®«") return "å‘½å®®";
    if (name === "è´¢å¸›") return "è²¡å¸›";
    if (name === "å®˜ç¦„") return "å®˜ç¥¿";
    // å…¶ä»–ä¿æŒåŸæ¨£ï¼ˆå…„å¼Ÿã€å¤«å¦»ã€å­å¥³â€¦æœ¬ä¾†å°±ä¸€æ¨£ï¼‰
    return name;
  });
} else {
  PALACE_RING = PALACE_DEFAULT.slice();
}



        if (!bazi) throw new Error("å¾Œç«¯æœªå›å‚³ bazi");

        // é€²å…¥ç³»çµ±ï¼šé¡¯ç¤º workspace nav + CTAï¼Œä¸¦æ”¶èµ·è¼¸å…¥å¡
        document.getElementById("system").classList.remove("hidden");
        document.getElementById("workspaceNav").classList.remove("hidden");
        document.getElementById("navCta").classList.remove("hidden");
        document.getElementById("inputCard").classList.add("hidden");

        // summary
        document.getElementById("summaryBirth").textContent =
          `${vy}/${pad2(vm)}/${pad2(vd)} Â· ${pad2(vh)}:${pad2(vmin)}ï¼ˆå…¬æ›†ï¼‰`;
        document.getElementById("summaryDM").textContent = bazi.dmElement || "â€”";
        document.getElementById("summaryDominant").textContent = (bazi.tenGod?.dominant || "â€”").trim() || "â€”";
        const reds = bazi.liuyue2026?.redMonths || [];
        document.getElementById("summaryRedMonths").textContent = reds.length ? reds.join("ã€") : "åå°‘ï¼ˆå¯ç©©æ¨ï¼‰";

        // bazi + canggan + bars
        renderPillars(bazi);
        renderBar("surfaceWx", bazi.wuxing?.surface, 4);
        renderBar("strategicWx", bazi.wuxing?.strategic, bazi.wuxing?.maxStrategic || 1);

        // tenGod command box (DB first)
        const dominant = (bazi.tenGod?.dominant || "").trim();
        const cmd = dominant && dbContent.tenGods?.[dominant] ? dbContent.tenGods[dominant] : "";
        document.getElementById("tenGodCommand").textContent =
          cmd || `ï¼ˆè³‡æ–™åº«å°šæœªå¡«å…¥ã€Œ${dominant || "â€”"}ã€çš„åç¥æŒ‡ä»¤ã€‚ä½ å¯ä»¥å…ˆåœ¨ ten_god_analysis è£œä¸Š 2026 å…§å®¹ã€‚ï¼‰`;

        // liuyue
        renderLiuyue(bazi);

        // ziwei grid
        renderZiwei(ziwei);
        document.getElementById("ziweiMeta").textContent =
          ziwei ? `å‘½å®®ï¼š${ziwei.core?.minggong || "â€”"}ï½œäº”è¡Œå±€ï¼š${ziwei.core?.wuxingju || "â€”"}` : "â€”";

        // tactical panel
        const tactics = computeDynamicTactics(bazi);
        const tacticalBox = document.getElementById("tacticalBox");
        tacticalBox.innerHTML = tactics.length
          ? tactics.map(x => `<div class="p-4 rounded-xl border ${toneClass(x.tone)} text-sm leading-relaxed">${x.text}</div>`).join("")
          : `<div class="text-sm text-slate-400 italic">ï¼ˆæˆ°è¡“æç¤ºæš«ä¸å¯ç”¨ï¼‰</div>`;

        // default select å‘½å®®
        if (ziwei){
          selectPalace("å‘½å®®");
        } else {
          document.getElementById("palaceTitle").textContent = "ç´«å¾®æš«ä¸å¯ç”¨";
          document.getElementById("palaceDetailBody").innerHTML = `<div class="p-4 rounded-xl border border-white/10 bg-white/5 text-sm text-slate-300">
            å¾Œç«¯ iztro å¯èƒ½å‡ºéŒ¯ï¼ˆæˆ–æ‰“åŒ…å•é¡Œï¼‰ã€‚è«‹å…ˆç¢ºèª worker build/ä¾è³´ï¼Œå†é‡è©¦ã€‚
          </div>`;
        }

        document.getElementById("ws-summary").scrollIntoView({ behavior:"smooth", block:"start" });

      }catch(e){
        console.error(e);
        alert("ç³»çµ±å¿™ç¢Œä¸­æˆ–è³‡æ–™æœ‰èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚\n\nè©³ç´°ï¼š" + (e?.message || e));
      }finally{
        btn.disabled = false;
        btn.textContent = original;
        hint.textContent = "";
      }
    }

    // ====== INIT SELECTORS ======
    function initSelectors(){
      const y   = document.getElementById("birthYear");
      const m   = document.getElementById("birthMonth");
      const d   = document.getElementById("birthDay");
      const h   = document.getElementById("birthHour");
      const min = document.getElementById("birthMinute");

      const nowY = new Date().getFullYear();
      for (let i = nowY; i >= 1940; i--) y.add(new Option(i + " å¹´", i));
      for (let i = 1; i <= 12; i++) m.add(new Option(i + " æœˆ", i));
      for (let i = 0; i < 24; i++) h.add(new Option(pad2(i) + " æ™‚", i));
      ["00","15","30","45"].forEach(v => min.add(new Option(v + " åˆ†", v)));

      function updateDays(){
        const year = Number(y.value);
        const month = Number(m.value);
        const cur = d.value;

        d.innerHTML = "";
        const days = new Date(year, month, 0).getDate();
        for (let i = 1; i <= days; i++){
          const opt = new Option(i + " æ—¥", i);
          d.add(opt);
        }
        if (cur && Number(cur) <= days) d.value = cur;
      }

      y.value = "1990";
      m.value = "1";
      h.value = "12";
      min.value = "00";
      updateDays();

      y.addEventListener("change", updateDays);
      m.addEventListener("change", updateDays);
    }

    // ====== BOOT ======
    document.addEventListener("DOMContentLoaded", async ()=>{
      initSelectors();
      document.getElementById("btnLaunch").addEventListener("click", calculate);
      await loadDbContent();

      // Mobile Bottom Sheet é—œé–‰äº‹ä»¶
      const closeBtn = document.getElementById("palaceSheetClose");
      const backdrop = document.getElementById("palaceSheetBackdrop");
      if (closeBtn) closeBtn.addEventListener("click", closePalaceSheet);
      if (backdrop) backdrop.addEventListener("click", closePalaceSheet);
    });
  </script>

  <!-- æ‰‹æ©Ÿç‰ˆå®®ä½è©³è§£ Bottom Sheet -->
  <div id="palaceSheetBackdrop" class="fixed inset-0 bg-black/40 z-40 hidden md:hidden"></div>

  <div id="palaceSheet" class="palace-sheet md:hidden">
    <div class="palace-sheet-handle"></div>
    <div class="palace-sheet-header">
      <div>
        <div class="section-subtitle mb-1">Palace Detail</div>
        <div id="mobilePalaceTitle" class="text-xl font-black text-amber-400">è«‹é»å®®ä½</div>
        <div id="mobilePalaceSub" class="text-xs text-slate-400 mt-1 leading-relaxed"></div>
      </div>
      <button id="palaceSheetClose" type="button" class="palace-sheet-close">
        é—œé–‰
      </button>
    </div>

    <div id="mobilePalaceBody" class="mt-4 space-y-4 overflow-y-auto"
         style="max-height: calc(80vh - 72px);">
      <div class="text-center py-6 text-slate-500 italic text-xs">
        é»æ“Šç´«å¾®æ–¹ç›¤çš„ä»»ä¸€å®®ä½ï¼Œé€™è£¡æœƒé¡¯ç¤ºè©³è§£ã€‚
      </div>
    </div>
  </div>
</body>
</html>


